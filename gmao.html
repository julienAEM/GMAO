<!--
  GMAO (Gestion de Maintenance Assistée par Ordinateur) – Application web

  Cette page est une application autonome permettant de gérer des demandes d'intervention
  et de suivre l’avancement des travaux. Elle adopte le style des fichiers existants
  dans le dépôt (palette de couleurs bleu foncé et accent bleu clair) et fonctionne sans
  serveur en utilisant le stockage local (localStorage) pour sauvegarder les données
  jusqu’à ce qu’un serveur backend soit disponible.  Le code est commenté en français
  pour en faciliter l’adaptation.  Les sections principales sont :
    • Accueil : tableau de bord et indicateurs (KPI)
    • Nouvelle demande : formulaire pour créer une demande unique
    • Demandes en approbation : liste des demandes en attente avec actions
    • Base de données : recherche et filtrage de toutes les demandes
    • Journal de travail : saisie des comptes‑rendus par les corps de métier
    • Admin : gestion des listes déroulantes et paramètres

  Cette version utilise uniquement du HTML, CSS et JavaScript. Toutes les données
  sont enregistrées dans localStorage sous la clé "gmaoRequests" (tableau d’objets)
  et "gmaoConfig" (paramètres).  Lorsqu’un serveur sera disponible, ces appels
  pourront être remplacés par des requêtes API.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GMAO – Gestion des demandes de maintenance</title>
  <style>
    /*
      Variables de couleur pour s’aligner sur le thème existant
      (bleu foncé, bleu moyen et bleu clair).  La couleur principale sert
      de fond; la couleur secondaire pour les en‑têtes et l’accent pour
      les boutons et éléments interactifs.  Le texte est blanc pour un
      contraste élevé.
    */
    :root {
      --primary-color: #253746;
      --secondary-color: #324e67;
      --accent-color: #0078c8;
      --text-color: #ffffff;
      --light-bg: #f5f5f5;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--primary-color);
      color: var(--text-color);
      overflow-y: scroll;
    }

    h1, h2, h3 {
      margin: 0.5em 0;
      color: var(--accent-color);
    }

    /* Barre de navigation horizontale en haut de la page.  Chaque onglet
       est un bouton qui appelle showTab() pour afficher la section
       correspondante.  Les onglets actifs sont soulignés. */
    nav {
      display: flex;
      background-color: var(--secondary-color);
      border-bottom: 2px solid var(--accent-color);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav button {
      flex: 1;
      padding: 1em;
      background: none;
      border: none;
      color: var(--text-color);
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    nav button:hover {
      background-color: var(--primary-color);
    }
    nav button.active {
      border-bottom: 3px solid var(--accent-color);
      color: var(--accent-color);
    }

    /* Conteneur pour les pages; chaque section occupe toute la largeur et
       est cachée par défaut sauf celle qui est active. */
    .tab-content {
      display: none;
      padding: 1em 2em;
    }
    .tab-content.active {
      display: block;
    }

    /* Style général des formulaires et tableaux */
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1em;
      margin-bottom: 1em;
      background-color: var(--secondary-color);
      padding: 1em;
      border-radius: 8px;
    }
    form label {
      margin-bottom: 0.2em;
      color: var(--accent-color);
      font-weight: bold;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 0.5em;
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      color: #000;
      box-sizing: border-box;
    }
    form textarea {
      resize: vertical;
      min-height: 80px;
    }
    form .full-row {
      grid-column: 1 / -1;
    }
    .btn {
      padding: 0.6em 1.2em;
      background-color: var(--accent-color);
      border: none;
      color: var(--text-color);
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    .btn:hover {
      background-color: #005a99;
    }
    .btn.small {
      padding: 0.4em 0.8em;
      font-size: 0.9em;
    }

    /* Amélioration de l'apparence des formulaires et éléments interactifs
       pour un rendu plus professionnel.  Les formulaires utilisent
       un fond légèrement translucide pour se distinguer du fond du
       conteneur, et les champs de type fichier sont explicitement
       stylés pour conserver un contraste élevé. */
    form {
      background-color: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--primary-color);
    }
    input[type="file"] {
      background-color: var(--light-bg);
      color: #000;
    }

    /* Personnalisation des cases à cocher pour les conditions afin
       qu’elles ressemblent à des boutons sélectionnables.  Chaque
       étiquette agit comme un bouton; lorsqu’un choix est coché,
       l’arrière‑plan passe à la couleur d’accent et le texte reste
       visible sur fond sombre. */
    #special-conditions label,
    #intervention-conditions label {
      display: flex;
      align-items: center;
      background-color: var(--primary-color);
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      padding: 0.3em 0.6em;
      color: var(--text-color);
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #special-conditions label input[type="checkbox"],
    #intervention-conditions label input[type="checkbox"] {
      margin-right: 0.3em;
    }
    #special-conditions label:hover,
    #intervention-conditions label:hover {
      background-color: var(--secondary-color);
    }
    #special-conditions input[type="checkbox"]:checked + span,
    #intervention-conditions input[type="checkbox"]:checked + span {
      color: var(--accent-color);
      font-weight: bold;
    }

    /* Tableau avec lignes alternées pour une meilleure lisibilité */
    table tbody tr:nth-child(even) {
      background-color: var(--primary-color);
    }
    table tbody tr:nth-child(odd) {
      background-color: var(--secondary-color);
    }

    /* Légère ombre portée sur les boutons pour les faire ressortir */
    .btn {
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
      background-color: var(--secondary-color);
      border: 1px solid var(--accent-color);
    }
    table thead {
      background-color: var(--primary-color);
    }
    table th, table td {
      padding: 0.5em;
      border: 1px solid var(--accent-color);
      text-align: left;
      color: var(--text-color);
    }
    table th {
      color: var(--accent-color);
    }
    .status-badge {
      display: inline-block;
      padding: 0.3em 0.6em;
      border-radius: 12px;
      color: var(--text-color);
      font-size: 0.8em;
      margin-right: 0.3em;
    }
    .status-en-attente { background-color: #9b59b6; }
    .status-approuvee { background-color: #27ae60; }
    .status-manque-info { background-color: #e67e22; }
    .status-en-attente-pieces { background-color: #d35400; }
    .status-a-ceduler { background-color: #f1c40f; color:#000; }
    .status-rejete { background-color: #c0392b; }
    .status-terminee { background-color: #2980b9; }

    /* Section KPI sous forme de cartes */
    .kpi-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
    }
    .kpi-card {
      flex: 1 1 200px;
      background-color: var(--secondary-color);
      border: 1px solid var(--accent-color);
      border-radius: 6px;
      padding: 1em;
      text-align: center;
    }
    .kpi-card h3 {
      margin: 0.2em 0;
      font-size: 1.1em;
      color: var(--accent-color);
    }
    .kpi-card p {
      margin: 0;
      font-size: 1.8em;
      font-weight: bold;
    }

    /* Boîte modale pour messages (manque d'information et rejet) */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: var(--secondary-color);
      padding: 1em;
      border-radius: 6px;
      width: 90%;
      max-width: 500px;
    }
    .modal-content h3 {
      margin-top: 0;
    }

    .flex-row {
      display: flex;
      gap: 0.5em;
    }

    /*
      Classes d'enveloppe pour donner aux sections un aspect professionnel
      similaire aux formulaires de changement de quart. Chaque section est
      encadrée dans un conteneur avec un en‑tête sombre, un trait
      accentué et un contenu sur fond plus clair. Ces classes permettent
      de reproduire la présentation soignée des pages "rapport de quart".
    */
    .page-wrapper {
      max-width: 1200px;
      margin: 2rem auto;
      background: var(--secondary-color);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .page-header {
      background: var(--primary-color);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      border-bottom: 3px solid var(--accent-color);
    }
    .page-header img {
      height: 40px;
      margin-right: 1rem;
    }
    .page-header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: var(--text-color);
    }
    .page-content {
      padding: 1.5rem;
    }
  </style>
</head>
<body>
  <nav>
    <button id="tab-home" class="active" onclick="showTab('home')">Accueil</button>
    <button id="tab-new" onclick="showTab('new')">Nouvelle demande</button>
    <button id="tab-approval" onclick="showTab('approval')">Demandes en approbation</button>
    <button id="tab-edit" onclick="showTab('edit')">Modification de demande</button>
    <button id="tab-backlogs" onclick="showTab('backlogs')">Backlogs</button>
    <button id="tab-planner" onclick="showTab('planner')">Planificateur</button>
    <button id="tab-worklog" onclick="showTab('worklog')">Journal de travail</button>
    <button id="tab-admin" onclick="showTab('admin')">Admin</button>
  </nav>

  <!-- Section Accueil -->
  <section id="home" class="tab-content active">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Tableau de bord GMAO</h1>
      </div>
      <div class="page-content">
        <div class="kpi-cards" id="kpiCards">
          <div class="kpi-card">
            <h3>Demandes en attente</h3>
            <p id="kpiEnAttente">0</p>
          </div>
          <div class="kpi-card">
            <h3>Demandes approuvées</h3>
            <p id="kpiApprouve">0</p>
          </div>
          <div class="kpi-card">
            <h3>Demandes en attente de pièces</h3>
            <p id="kpiPieces">0</p>
          </div>
          <div class="kpi-card">
            <h3>Demandes à cédule</h3>
            <p id="kpiCeduler">0</p>
          </div>
          <div class="kpi-card">
            <h3>Demandes complétées</h3>
            <p id="kpiTerminee">0</p>
          </div>
          <div class="kpi-card">
            <h3>Demandes rejetées</h3>
            <p id="kpiRejete">0</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Nouvelle demande -->
  <section id="new" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Nouvelle demande</h1>
      </div>
      <div class="page-content">
        <form id="request-form" onsubmit="event.preventDefault(); submitRequest();">
          <label>ID:</label>
          <input type="text" id="req-id" readonly />
          <label>Date:</label>
          <input type="date" id="req-date" required />
          <label>Demandeur:</label>
          <input type="text" id="req-demandeur" required />
          <label>Département concerné:</label>
          <select id="req-department" required></select>
          <label>Zone:</label>
          <select id="req-zone" required></select>
          <label>Équipement ou Service (description):</label>
          <input type="text" id="req-equipment-desc" />
          <label>NO. Équipement:</label>
          <input type="text" id="req-equipment-number" />
          <label>Métier (corps de métier):</label>
          <select id="req-trade"></select>
          <label>Heures prévues:</label>
          <input type="number" id="req-hours" min="0" step="0.25" />
          <label>Priorisation:</label>
          <select id="req-priority" required></select>
          <div id="special-conditions" class="full-row">
            <label><input type="checkbox" value="Espace clos" /> <span>Espace clos</span></label>
            <label><input type="checkbox" value="Travail à chaud" /> <span>Travail à chaud</span></label>
            <label><input type="checkbox" value="Levage" /> <span>Levage</span></label>
            <label><input type="checkbox" value="Nacelle" /> <span>Nacelle</span></label>
            <label><input type="checkbox" value="Autres" /> <span>Autres</span></label>
          </div>
          <div id="intervention-conditions" class="full-row">
            <label><input type="checkbox" value="En arrêt" /> <span>En arrêt</span></label>
            <label><input type="checkbox" value="En fonction" /> <span>En fonction</span></label>
            <label><input type="checkbox" value="En shutdown" /> <span>En shutdown</span></label>
            <label><input type="checkbox" value="Autres" /> <span>Autres</span></label>
          </div>
          <label>Description (250 caractères max):</label>
          <textarea id="req-description" maxlength="250" rows="3"></textarea>
          <label><input type="checkbox" id="longDescToggle" /> Description plus longue (500 caractères max)</label>
          <textarea id="req-description-long" maxlength="500" rows="4" style="display:none;"></textarea>
          <label>Ajouter des images / plans (max 5):</label>
          <input type="file" id="req-images" multiple accept="image/*" />
          <button type="submit" class="btn full-row">Envoyer nouvelle demande en approbation</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Section Demandes en approbation -->
  <section id="approval" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Demandes en approbation</h1>
      </div>
      <div class="page-content">
        <table id="approvalTable">
          <thead>
            <tr>
              <th>ID</th><th>Date</th><th>Demandeur</th><th>Département</th><th>Zone</th>
              <th>Équipement</th><th>Priorité</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modale pour manque d'information -->
    <div class="modal" id="infoModal">
      <div class="modal-content">
        <h3>Manque d'information</h3>
        <p>Veuillez indiquer les informations supplémentaires demandées :</p>
        <textarea id="infoMessage" rows="4" style="width:100%;"></textarea>
        <div class="flex-row" style="margin-top: 0.5em;">
          <button class="btn" onclick="sendInfoRequest()">Envoyer au demandeur</button>
          <button class="btn" onclick="closeModal('infoModal')">Annuler</button>
        </div>
      </div>
    </div>
    <!-- Modale pour rejet -->
    <div class="modal" id="rejectModal">
      <div class="modal-content">
        <h3>Rejeter la demande</h3>
        <p>Raison du rejet :</p>
        <textarea id="rejectMessage" rows="4" style="width:100%;"></textarea>
        <div class="flex-row" style="margin-top: 0.5em;">
          <button class="btn" onclick="sendReject()">Rejeter</button>
          <button class="btn" onclick="closeModal('rejectModal')">Annuler</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Modification de demande -->
  <section id="edit" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Modification de demande</h1>
      </div>
      <div class="page-content">
        <p>
          Entrez l'ID de la demande à modifier : 
          <input type="text" id="edit-id-input" style="width:100px;" />
          <button class="btn" onclick="loadEditRequest()">Charger</button>
        </p>
        <div id="editSection" style="display:none;">
          <form id="edit-form" onsubmit="event.preventDefault(); saveEdit();">
            <label>ID:</label>
            <input type="text" id="edit-id" readonly />
            <label>Date:</label>
            <input type="date" id="edit-date" required />
            <label>Demandeur:</label>
            <input type="text" id="edit-demandeur" required />
            <label>Département:</label>
            <select id="edit-department" required></select>
            <label>Zone:</label>
            <select id="edit-zone" required></select>
            <label>Métier:</label>
            <select id="edit-trade"></select>
            <label>Heures prévues:</label>
            <input type="number" id="edit-hours" min="0" step="0.25" />
            <label>Équipement/Service:</label>
            <input type="text" id="edit-equipment-desc" />
            <label>NO. Équipement:</label>
            <input type="text" id="edit-equipment-number" />
            <label>Priorité:</label>
            <select id="edit-priority" required></select>
            <div id="edit-special-conditions" class="full-row">
              <label><input type="checkbox" value="Espace clos" /> <span>Espace clos</span></label>
              <label><input type="checkbox" value="Travail à chaud" /> <span>Travail à chaud</span></label>
              <label><input type="checkbox" value="Levage" /> <span>Levage</span></label>
              <label><input type="checkbox" value="Nacelle" /> <span>Nacelle</span></label>
              <label><input type="checkbox" value="Autres" /> <span>Autres</span></label>
            </div>
            <div id="edit-intervention-conditions" class="full-row">
              <label><input type="checkbox" value="En arrêt" /> <span>En arrêt</span></label>
              <label><input type="checkbox" value="En fonction" /> <span>En fonction</span></label>
              <label><input type="checkbox" value="En shutdown" /> <span>En shutdown</span></label>
              <label><input type="checkbox" value="Autres" /> <span>Autres</span></label>
            </div>
            <label>Description:</label>
            <textarea id="edit-description" maxlength="250" rows="3"></textarea>
            <label><input type="checkbox" id="edit-longDescToggle" /> Description plus longue</label>
            <textarea id="edit-description-long" maxlength="500" rows="4" style="display:none;"></textarea>
            <label>Ajouter des images:</label>
            <input type="file" id="edit-images" multiple accept="image/*" />
            <button type="submit" class="btn">Enregistrer les modifications</button>
            <button type="button" class="btn" onclick="reopenRequest()">Réouvrir demande</button>
            <button type="button" class="btn" onclick="printRequest()">Imprimer en PDF</button>
            <div id="editMessage" class="full-row"></div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Backlogs -->
  <section id="backlogs" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Backlogs</h1>
      </div>
      <div class="page-content">
        <div style="display: flex; flex-wrap: wrap; gap: 1em;">
          <input type="text" id="search-id" placeholder="Rechercher par ID" style="flex:1;" />
          <input type="text" id="search-keyword" placeholder="Mot-clé" style="flex:2;" />
          <input type="text" id="search-demandeur" placeholder="Demandeur" style="flex:1;" />
          <label>Date de début
            <input type="date" id="search-date-start" />
          </label>
          <label>Date de fin
            <input type="date" id="search-date-end" />
          </label>
          <select id="search-department"><option value="">--Département--</option></select>
          <select id="search-zone"><option value="">--Zone--</option></select>
          <select id="search-trade"><option value="">--Métier--</option></select>
          <select id="search-priority"><option value="">--Priorité--</option></select>
          <select id="search-status">
            <option value="">--Statut--</option>
            <option value="en-attente">En attente</option>
            <option value="approuvee">Approuvée</option>
            <option value="manque-info">Manque info</option>
            <option value="en-attente-pieces">Attente pièces</option>
            <option value="a-ceduler">À cédule</option>
            <option value="rejete">Rejetée</option>
            <option value="terminee">Terminée</option>
          </select>
          <button class="btn" onclick="performSearch()">Rechercher</button>
        </div>
        <table id="databaseTable">
          <thead>
            <tr>
              <th>ID</th><th>Date</th><th>Demandeur</th><th>Département</th><th>Zone</th>
              <th>Équipement</th><th>Métier</th><th>Priorité</th><th>Statut</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Section Planificateur -->
  <section id="planner" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Planificateur hebdomadaire</h1>
      </div>
      <div class="page-content">
        <div id="plannerTable"></div>
        <button class="btn" onclick="exportPlannerCSV()">Exporter en CSV</button>
      </div>
    </div>
  </section>

  <!-- Section Journal de travail -->
  <section id="worklog" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Journal de travail</h1>
      </div>
      <div class="page-content">
        <p>
          Entrez le numéro de la demande (DT) ou bon de travail (BT) :
          <input type="text" id="worklog-id" style="width:100px;" />
          <button class="btn" onclick="loadWorklogRequest()">Charger</button>
        </p>
        <div id="worklogSection" style="display:none;">
          <form id="worklog-form" onsubmit="event.preventDefault(); submitWorklog();">
            <label>Date du travail :</label>
            <input type="date" id="worklog-date" required />
            <label>Statut du travail :</label>
            <select id="worklog-status" required>
              <option value="terminee">Complété</option>
              <option value="annulee">Annulé</option>
              <option value="a-reporter">À reporter</option>
              <option value="manque-pieces">Pas terminé - manque pièces</option>
              <option value="a-continuer">À continuer</option>
              <option value="autre">Autres</option>
            </select>
            <label>Description du travail effectué :</label>
            <textarea id="worklog-description" rows="4" maxlength="500"></textarea>
            <label>Ajouter des photos (facultatif) :</label>
            <input type="file" id="worklog-images" multiple accept="image/*" />
            <button type="submit" class="btn">Soumettre</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Admin -->
  <section id="admin" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img src="https://user-images.githubusercontent.com/placeholder/000000-0.png" alt="Logo AEM" onerror="this.style.display='none'" />
        <h1>Administration</h1>
      </div>
      <div class="page-content">
        <form id="admin-form" onsubmit="event.preventDefault(); saveConfig();">
          <label>Départements (séparés par des virgules) :</label>
          <textarea id="admin-departments" rows="2"></textarea>
          <label>Zones (séparées par des virgules) :</label>
          <textarea id="admin-zones" rows="2"></textarea>
          <label>Priorités (séparées par des virgules) :</label>
          <textarea id="admin-priorities" rows="1"></textarea>
          <label>Métiers (séparés par des virgules) :</label>
          <textarea id="admin-trades" rows="2"></textarea>
          <button type="submit" class="btn full-row">Enregistrer la configuration</button>
        </form>
      </div>
    </div>
  </section>

  <script>
    /* -------------------------------------------------------------------- */
    /* Fonctions utilitaires et stockage                                     */
    /* -------------------------------------------------------------------- */

    /** Récupère la liste des demandes depuis le stockage. */
    function getRequests() {
      return JSON.parse(localStorage.getItem('gmaoRequests') || '[]');
    }

    /** Sauvegarde les demandes dans le stockage. */
    function saveRequests(data) {
      localStorage.setItem('gmaoRequests', JSON.stringify(data));
    }

    /** Récupère la configuration depuis le stockage. */
    function getConfig() {
      const defaultConfig = {
        departments: ['mécanique','electrique','opération','technique','projet','formation'],
        zones: [''],
        priorities: ['Priorite 1','Priorite 2','Priorite 3','Priorite 4'],
        trades: ['']
      };
      return JSON.parse(localStorage.getItem('gmaoConfig') || JSON.stringify(defaultConfig));
    }

    /** Sauvegarde la configuration dans le stockage. */
    function saveConfig() {
      const config = {
        departments: document.getElementById('admin-departments').value.split(',').map(s => s.trim()).filter(s => s),
        zones: document.getElementById('admin-zones').value.split(',').map(s => s.trim()).filter(s => s),
        priorities: document.getElementById('admin-priorities').value.split(',').map(s => s.trim()).filter(s => s),
        trades: document.getElementById('admin-trades').value.split(',').map(s => s.trim()).filter(s => s)
      };
      localStorage.setItem('gmaoConfig', JSON.stringify(config));
      populateDropdowns();
      alert('Configuration enregistrée.');
    }

    /** Génère un ID unique pour chaque demande (timestamp + incrément). */
    function generateUniqueId() {
      const now = Date.now();
      const lastId = parseInt(localStorage.getItem('gmaoLastId') || '0');
      const newId = now > lastId ? now : lastId + 1;
      localStorage.setItem('gmaoLastId', newId.toString());
      return newId;
    }

    /** Insère les listes déroulantes en fonction de la configuration actuelle. */
    function populateDropdowns() {
      const config = getConfig();
      const deptSelects = document.querySelectorAll('#req-department, #edit-department, #search-department');
      const zoneSelects = document.querySelectorAll('#req-zone, #edit-zone, #search-zone');
      const prioSelects = document.querySelectorAll('#req-priority, #edit-priority, #search-priority');
      const tradeSelects = document.querySelectorAll('#req-trade, #edit-trade, #search-trade');
      deptSelects.forEach(sel => {
        sel.innerHTML = '<option value="">--Choisir--</option>' + config.departments.map(d => `<option value="${d}">${d}</option>`).join('');
      });
      zoneSelects.forEach(sel => {
        sel.innerHTML = '<option value="">--Choisir--</option>' + config.zones.map(d => `<option value="${d}">${d}</option>`).join('');
      });
      prioSelects.forEach(sel => {
        sel.innerHTML = '<option value="">--Choisir--</option>' + config.priorities.map(d => `<option value="${d}">${d}</option>`).join('');
      });
      tradeSelects.forEach(sel => {
        sel.innerHTML = '<option value="">--Choisir--</option>' + config.trades.map(d => `<option value="${d}">${d}</option>`).join('');
      });
    }

    /** Met à jour les KPI sur la page d'accueil. */
    function updateKpi() {
      const reqs = getRequests();
      const count = status => reqs.filter(r => r.status === status).length;
      document.getElementById('kpiEnAttente').textContent = count('en-attente');
      document.getElementById('kpiApprouve').textContent = count('approuvee');
      document.getElementById('kpiPieces').textContent = count('en-attente-pieces');
      document.getElementById('kpiCeduler').textContent = count('a-ceduler');
      document.getElementById('kpiTerminee').textContent = count('terminee');
      document.getElementById('kpiRejete').textContent = count('rejete');
    }

    /** Soumission d'une nouvelle demande. */
    async function submitRequest() {
      const form = document.getElementById('request-form');
      const req = {
        id: document.getElementById('req-id').value,
        date: document.getElementById('req-date').value,
        demandeur: document.getElementById('req-demandeur').value.trim(),
        department: document.getElementById('req-department').value,
        zone: document.getElementById('req-zone').value,
        equipmentDesc: document.getElementById('req-equipment-desc').value.trim(),
        equipmentNumber: document.getElementById('req-equipment-number').value.trim(),
        trade: document.getElementById('req-trade').value,
        estimatedHours: parseFloat(document.getElementById('req-hours').value) || '',
        priority: document.getElementById('req-priority').value,
        specialConditions: Array.from(document.querySelectorAll('#special-conditions input:checked')).map(i => i.value),
        interventionConditions: Array.from(document.querySelectorAll('#intervention-conditions input:checked')).map(i => i.value),
        description: document.getElementById('req-description').value.trim(),
        descriptionLong: document.getElementById('longDescToggle').checked ? document.getElementById('req-description-long').value.trim() : '',
        status: 'en-attente'
      };
      // gestion des images
      const images = await processFiles(document.getElementById('req-images'));
      req.images = images;
      const requests = getRequests();
      requests.push(req);
      saveRequests(requests);
      form.reset();
      document.getElementById('req-id').value = generateUniqueId();
      updateKpi();
      renderApprovalTable();
      alert('Demande soumise avec succès.');
    }

    /** Lecture des fichiers images et retour sous forme d'objets { name, data } */
    function processFiles(input) {
      return new Promise(resolve => {
        const files = Array.from(input.files || []);
        if (files.length === 0) return resolve([]);
        let count = 0;
        const images = [];
        files.forEach(f => {
          const reader = new FileReader();
          reader.onload = e => {
            images.push({ name: f.name, data: e.target.result });
            count++;
            if (count === files.length) resolve(images);
          };
          reader.readAsDataURL(f);
        });
      });
    }

    /* -------------------------------------------------------------------- */
    /* Fonctions pour la liste des demandes et actions d'approbation          */
    /* -------------------------------------------------------------------- */

    /** Rend la liste des demandes dans la table d'approbation. */
    function renderApprovalTable() {
      const tableBody = document.querySelector('#approvalTable tbody');
      const requests = getRequests();
      tableBody.innerHTML = '';
      requests.filter(r => ['en-attente','approuvee','manque-info','en-attente-pieces','a-ceduler'].includes(r.status)).forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${req.id}</td><td>${req.date}</td><td>${req.demandeur}</td><td>${req.department}</td><td>${req.zone}</td><td>${req.equipmentDesc || ''}</td><td>${req.priority}</td><td>${formatStatus(req.status)}</td>`;
        const actionsTd = document.createElement('td');
        // Boutons d'action
        const btnApprove = document.createElement('button');
        btnApprove.className = 'btn small';
        btnApprove.textContent = 'Approuver';
        btnApprove.onclick = () => updateRequestStatus(req.id, 'approuvee');
        const btnInfo = document.createElement('button');
        btnInfo.className = 'btn small';
        btnInfo.textContent = 'Manque info';
        btnInfo.onclick = () => openModal('infoModal', req.id);
        const btnPieces = document.createElement('button');
        btnPieces.className = 'btn small';
        btnPieces.textContent = 'Attente pièces';
        btnPieces.onclick = () => updateRequestStatus(req.id, 'en-attente-pieces');
        const btnCeduler = document.createElement('button');
        btnCeduler.className = 'btn small';
        btnCeduler.textContent = 'À cédule';
        btnCeduler.onclick = () => updateRequestStatus(req.id, 'a-ceduler');
        const btnReject = document.createElement('button');
        btnReject.className = 'btn small';
        btnReject.textContent = 'Rejeter';
        btnReject.onclick = () => openModal('rejectModal', req.id);
        actionsTd.appendChild(btnApprove);
        actionsTd.appendChild(btnInfo);
        actionsTd.appendChild(btnPieces);
        actionsTd.appendChild(btnCeduler);
        actionsTd.appendChild(btnReject);
        tr.appendChild(actionsTd);
        tableBody.appendChild(tr);
      });
    }

    /** Met à jour le statut d'une demande et rafraîchit les listes. */
    function updateRequestStatus(id, status) {
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      req.status = status;
      if (!req.comments) req.comments = [];
      req.comments.push({ date: new Date().toISOString(), status });
      saveRequests(requests);
      renderApprovalTable();
      updateKpi();
    }

    /** Affiche l'intitulé human-friendly d'un statut. */
    function formatStatus(status) {
      switch (status) {
        case 'en-attente': return '<span class="status-badge status-en-attente">En attente</span>';
        case 'approuvee': return '<span class="status-badge status-approuvee">Approuvée</span>';
        case 'manque-info': return '<span class="status-badge status-manque-info">Manque info</span>';
        case 'en-attente-pieces': return '<span class="status-badge status-en-attente-pieces">Attente pièces</span>';
        case 'a-ceduler': return '<span class="status-badge status-a-ceduler">À cédule</span>';
        case 'rejete': return '<span class="status-badge status-rejete">Rejetée</span>';
        case 'terminee': return '<span class="status-badge status-terminee">Terminée</span>';
        default: return status;
      }
    }

    /** Ouvre une modale de message pour manque d'information ou rejet. */
    function openModal(modalId, requestId) {
      document.getElementById(modalId).style.display = 'flex';
      // Stocker l'ID dans l'élément modal pour le récupérer ensuite
      document.getElementById(modalId).dataset.requestId = requestId;
    }

    /** Ferme la modale spécifiée. */
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    /** Envoie une demande d'informations supplémentaires au demandeur. */
    function sendInfoRequest() {
      const modal = document.getElementById('infoModal');
      const id = modal.dataset.requestId;
      const message = document.getElementById('infoMessage').value.trim();
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (req) {
        req.status = 'manque-info';
        if (!req.comments) req.comments = [];
        req.comments.push({ date: new Date().toISOString(), status: 'manque-info', message });
        saveRequests(requests);
        renderApprovalTable();
        updateKpi();
      }
      document.getElementById('infoMessage').value = '';
      closeModal('infoModal');
    }

    /** Envoie un message de rejet pour la demande. */
    function sendReject() {
      const modal = document.getElementById('rejectModal');
      const id = modal.dataset.requestId;
      const message = document.getElementById('rejectMessage').value.trim();
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (req) {
        req.status = 'rejete';
        if (!req.comments) req.comments = [];
        req.comments.push({ date: new Date().toISOString(), status: 'rejete', message });
        saveRequests(requests);
        renderApprovalTable();
        updateKpi();
      }
      document.getElementById('rejectMessage').value = '';
      closeModal('rejectModal');
    }

    /* -------------------------------------------------------------------- */
    /* Fonctions pour la recherche et l’affichage des backlogs               */
    /* -------------------------------------------------------------------- */

    /** Lance la recherche dans le backlogs selon les filtres. */
    function performSearch() {
      const id = document.getElementById('search-id').value.trim();
      const keyword = document.getElementById('search-keyword').value.trim().toLowerCase();
      const demandeur = document.getElementById('search-demandeur').value.trim().toLowerCase();
      const dateStart = document.getElementById('search-date-start').value;
      const dateEnd = document.getElementById('search-date-end').value;
      const department = document.getElementById('search-department').value;
      const zone = document.getElementById('search-zone').value;
      const trade = document.getElementById('search-trade').value;
      const priority = document.getElementById('search-priority').value;
      const status = document.getElementById('search-status').value;
      const reqs = getRequests();
      const results = reqs.filter(r => {
        if (id && r.id !== id) return false;
        if (keyword && !(`${r.demandeur} ${r.equipmentDesc} ${r.equipmentNumber} ${r.description}`.toLowerCase().includes(keyword))) return false;
        if (demandeur && !r.demandeur.toLowerCase().includes(demandeur)) return false;
        if (dateStart && r.date < dateStart) return false;
        if (dateEnd && r.date > dateEnd) return false;
        if (department && r.department !== department) return false;
        if (zone && r.zone !== zone) return false;
        if (trade && r.trade !== trade) return false;
        if (priority && r.priority !== priority) return false;
        if (status && r.status !== status) return false;
        return true;
      });
      const tbody = document.querySelector('#databaseTable tbody');
      tbody.innerHTML = '';
      results.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td>${r.date}</td><td>${r.demandeur}</td><td>${r.department}</td><td>${r.zone}</td><td>${r.equipmentDesc || ''}</td><td>${r.trade || ''}</td><td>${r.priority}</td><td>${formatStatus(r.status)}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* -------------------------------------------------------------------- */
    /* Fonctions pour la modification de demandes                            */
    /* -------------------------------------------------------------------- */

    // Objet pour suivre l'état d'édition
    const editState = { currentId: null };

    /** Charge la demande à éditer selon l'ID entré. */
    function loadEditRequest() {
      const id = document.getElementById('edit-id-input').value.trim();
      if (!id) return;
      const req = getRequests().find(r => r.id === id);
      if (!req) {
        alert('Demande introuvable.');
        return;
      }
      editState.currentId = id;
      document.getElementById('editSection').style.display = 'block';
      document.getElementById('edit-id').value = req.id;
      document.getElementById('edit-date').value = req.date;
      document.getElementById('edit-demandeur').value = req.demandeur;
      document.getElementById('edit-department').value = req.department;
      document.getElementById('edit-zone').value = req.zone;
      document.getElementById('edit-trade').value = req.trade || '';
      document.getElementById('edit-hours').value = req.estimatedHours || '';
      document.getElementById('edit-equipment-desc').value = req.equipmentDesc || '';
      document.getElementById('edit-equipment-number').value = req.equipmentNumber || '';
      document.getElementById('edit-priority').value = req.priority;
      // conditions spéciales
      document.querySelectorAll('#edit-special-conditions input').forEach(chk => {
        chk.checked = req.specialConditions && req.specialConditions.includes(chk.value);
      });
      document.querySelectorAll('#edit-intervention-conditions input').forEach(chk => {
        chk.checked = req.interventionConditions && req.interventionConditions.includes(chk.value);
      });
      document.getElementById('edit-description').value = req.description;
      document.getElementById('edit-longDescToggle').checked = !!req.descriptionLong;
      document.getElementById('edit-description-long').value = req.descriptionLong || '';
      document.getElementById('edit-description-long').style.display = req.descriptionLong ? 'block' : 'none';
    }

    /** Enregistre les modifications apportées à la demande en cours. */
    function saveEdit() {
      const id = editState.currentId;
      if (!id) return;
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      req.date = document.getElementById('edit-date').value;
      req.demandeur = document.getElementById('edit-demandeur').value.trim();
      req.department = document.getElementById('edit-department').value;
      req.zone = document.getElementById('edit-zone').value;
      req.trade = document.getElementById('edit-trade').value;
      req.estimatedHours = parseFloat(document.getElementById('edit-hours').value) || '';
      req.equipmentDesc = document.getElementById('edit-equipment-desc').value.trim();
      req.equipmentNumber = document.getElementById('edit-equipment-number').value.trim();
      req.priority = document.getElementById('edit-priority').value;
      req.specialConditions = Array.from(document.querySelectorAll('#edit-special-conditions input:checked')).map(i => i.value);
      req.interventionConditions = Array.from(document.querySelectorAll('#edit-intervention-conditions input:checked')).map(i => i.value);
      req.description = document.getElementById('edit-description').value.trim();
      req.descriptionLong = document.getElementById('edit-longDescToggle').checked ? document.getElementById('edit-description-long').value.trim() : '';
      processFiles(document.getElementById('edit-images')).then(images => {
        if (images.length) {
          if (!req.images) req.images = [];
          req.images = req.images.concat(images);
        }
        saveRequests(requests);
        const msg = document.getElementById('editMessage');
        msg.style.color = '#27ae60';
        msg.textContent = 'Modifications enregistrées.';
        updateKpi();
        renderApprovalTable();
        performSearch();
      });
    }

    /** Réouvre la demande fermée (met le statut à en-attente). */
    function reopenRequest() {
      const id = editState.currentId;
      if (!id) return;
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      req.status = 'en-attente';
      if (!req.comments) req.comments = [];
      req.comments.push({ date: new Date().toISOString(), status: 'reouvert', comment: 'Demande réouverte par modification' });
      saveRequests(requests);
      const msg = document.getElementById('editMessage');
      msg.style.color = '#27ae60';
      msg.textContent = 'Demande réouverte.';
      updateKpi();
      renderApprovalTable();
      performSearch();
    }

    /** Imprime un bon de travail en format PDF/print. */
    function printRequest() {
      const id = editState.currentId;
      if (!id) return;
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      const w = window.open('', '_blank');
      w.document.write('<html><head><title>Bon de travail ' + req.id + '</title>');
      w.document.write('<style>body{font-family:Arial,sans-serif;padding:1em;} h1{color:#0078c8;} table{width:100%;border-collapse:collapse;} td, th{border:1px solid #ccc;padding:0.4em;} .images img{max-width:100%;margin:0.5em 0;}</style>');
      w.document.write('</head><body>');
      w.document.write('<h1>Bon de travail #' + req.id + '</h1>');
      w.document.write('<table>');
      w.document.write('<tr><th>Date</th><td>' + req.date + '</td></tr>');
      w.document.write('<tr><th>Demandeur</th><td>' + req.demandeur + '</td></tr>');
      w.document.write('<tr><th>Département</th><td>' + req.department + '</td></tr>');
      w.document.write('<tr><th>Zone</th><td>' + req.zone + '</td></tr>');
      w.document.write('<tr><th>Équipement/Service</th><td>' + (req.equipmentDesc || '') + '</td></tr>');
      w.document.write('<tr><th>NO. Équipement</th><td>' + (req.equipmentNumber || '') + '</td></tr>');
      w.document.write('<tr><th>Priorité</th><td>' + req.priority + '</td></tr>');
      w.document.write('<tr><th>Conditions spéciales</th><td>' + (req.specialConditions ? req.specialConditions.join(', ') : '') + '</td></tr>');
      w.document.write('<tr><th>Conditions d\'intervention</th><td>' + (req.interventionConditions ? req.interventionConditions.join(', ') : '') + '</td></tr>');
      w.document.write('<tr><th>Description</th><td>' + req.description + '</td></tr>');
      if (req.descriptionLong) w.document.write('<tr><th>Description longue</th><td>' + req.descriptionLong + '</td></tr>');
      w.document.write('</table>');
      if (req.images && req.images.length) {
        w.document.write('<h2>Pièces jointes</h2><div class="images">');
        req.images.forEach(img => {
          w.document.write('<img src="' + img.data + '" alt="' + img.name + '" />');
        });
        w.document.write('</div>');
      }
      if (req.worklogs && req.worklogs.length) {
        w.document.write('<h2>Travaux effectués</h2>');
        w.document.write('<table><tr><th>Date</th><th>Statut</th><th>Description</th></tr>');
        req.worklogs.forEach(log => {
          w.document.write('<tr><td>' + (log.date || '') + '</td><td>' + (log.status || '') + '</td><td>' + (log.description || '') + '</td></tr>');
        });
        w.document.write('</table>');
      }
      w.document.write('<h2>Commentaires / Travailleurs supplémentaires</h2>');
      w.document.write('<p style="border:1px solid #ccc;height:80px;"></p>');
      w.document.write('<p style="border:1px solid #ccc;height:80px;"></p>');
      w.document.write('</body></html>');
      w.document.close();
      w.print();
    }

    /* -------------------------------------------------------------------- */
    /* Fonctions pour la planification hebdomadaire                       */
    /* -------------------------------------------------------------------- */

    /** Génère la table de planification dans l'onglet Planificateur. */
function renderPlannerTable() {
      const container = document.getElementById('plannerTable');
      const requests = getRequests().filter(r => !['terminee','rejete'].includes(r.status));
      if (requests.length === 0) {
        container.innerHTML = '<p>Aucune demande à planifier.</p>';
        return;
      }
      const days = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      ['ID','Description','Département','Métier','Priorité','Heures prévues','Jour'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      const tbody = document.createElement('tbody');
      requests.forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${req.id}</td><td>${req.equipmentDesc || ''}</td><td>${req.department}</td>`;
        // colonne métier
        const tdTrade = document.createElement('td');
        tdTrade.textContent = req.trade || '';
        tr.appendChild(tdTrade);
        // colonne priorité
        const tdPrio = document.createElement('td');
        tdPrio.textContent = req.priority;
        tr.appendChild(tdPrio);
        // colonne heures prévues
        const tdHours = document.createElement('td');
        tdHours.textContent = req.estimatedHours || '';
        tr.appendChild(tdHours);
        const tdDay = document.createElement('td');
        const select = document.createElement('select');
        select.innerHTML = '<option value="">Non assigné</option>' + days.map(d => `<option value="${d}">${d}</option>`).join('');
        select.value = req.scheduleDay || '';
        select.onchange = () => {
          req.scheduleDay = select.value;
          saveRequests(getRequests());
        };
        tdDay.appendChild(select);
        tr.appendChild(tdDay);
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    /** Exporte la planification courante au format CSV (téléchargement). */
function exportPlannerCSV() {
      const requests = getRequests().filter(r => r.scheduleDay);
      if (requests.length === 0) {
        alert('Aucune tâche planifiée.');
        return;
      }
      const header = ['ID','Description','Département','Métier','Priorité','Heures prévues','Jour'];
      const rows = requests.map(r => [r.id, r.equipmentDesc || '', r.department, r.trade || '', r.priority, r.estimatedHours || '', r.scheduleDay]);
      let csv = header.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(v => '"' + (v || '').replace(/"/g,'""') + '"').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'planification.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    /** Initialisation de la page au chargement. */
    window.addEventListener('DOMContentLoaded', () => {
      populateDropdowns();
      updateKpi();
      // Pré-remplir les champs admin avec la configuration actuelle
      const config = getConfig();
      document.getElementById('admin-departments').value = config.departments.join(', ');
      document.getElementById('admin-zones').value = config.zones.join(', ');
      document.getElementById('admin-priorities').value = config.priorities.join(', ');
      document.getElementById('admin-trades').value = config.trades.join(', ');
      // Générer l’ID dans le champ lecture seule lors du focus
      document.getElementById('req-date').addEventListener('focus', () => {
        document.getElementById('req-id').value = generateUniqueId();
      }, { once: true });

      // Toggle de description longue pour le formulaire d'édition
      const editLongToggle = document.getElementById('edit-longDescToggle');
      if (editLongToggle) {
        editLongToggle.addEventListener('change', (e) => {
          const longField = document.getElementById('edit-description-long');
          longField.style.display = e.target.checked ? 'block' : 'none';
        });
      }
    });
  </script>
</body>
</html>
