<!--
  GMAO (Gestion de Maintenance Assistée par Ordinateur) – Application web

  Cette page est une application autonome permettant de gérer des demandes d'intervention
  et de suivre l’avancement des travaux. Elle adopte le style des fichiers existants
  dans le dépôt (palette de couleurs bleu foncé et accent bleu clair) et fonctionne sans
  serveur en utilisant le stockage local (localStorage) pour sauvegarder les données
  jusqu’à ce qu’un serveur backend soit disponible.  Le code est commenté en français
  pour en faciliter l’adaptation.  Les sections principales sont :
    • Accueil : tableau de bord et indicateurs (KPI)
    • Nouvelle demande : formulaire pour créer une demande unique
    • Demandes en approbation : liste des demandes en attente avec actions
    • Base de données : recherche et filtrage de toutes les demandes
    • Journal de travail : saisie des comptes‑rendus par les corps de métier
    • Admin : gestion des listes déroulantes et paramètres

  Cette version utilise uniquement du HTML, CSS et JavaScript. Toutes les données
  sont enregistrées dans localStorage sous la clé "gmaoRequests" (tableau d’objets)
  et "gmaoConfig" (paramètres).  Lorsqu’un serveur sera disponible, ces appels
  pourront être remplacés par des requêtes API.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GMAO – Gestion des demandes de maintenance</title>
  <style>
    /*
      Variables de couleur pour s’aligner sur le thème existant
      (bleu foncé, bleu moyen et bleu clair).  La couleur principale sert
      de fond; la couleur secondaire pour les en‑têtes et l’accent pour
      les boutons et éléments interactifs.  Le texte est blanc pour un
      contraste élevé.
    */
    :root {
      --primary-color: #253746;
      --secondary-color: #324e67;
      --accent-color: #0078c8;
      --text-color: #ffffff;
      --light-bg: #f5f5f5;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--primary-color);
      color: var(--text-color);
      overflow-y: scroll;
    }

    h1, h2, h3 {
      margin: 0.5em 0;
      color: var(--accent-color);
    }

    /* Barre de navigation horizontale en haut de la page.  Chaque onglet
       est un bouton qui appelle showTab() pour afficher la section
       correspondante.  Les onglets actifs sont soulignés. */
    nav {
      display: flex;
      background-color: var(--secondary-color);
      border-bottom: 2px solid var(--accent-color);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav button {
      flex: 1;
      padding: 1em;
      background: none;
      border: none;
      color: var(--text-color);
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    nav button:hover {
      background-color: var(--primary-color);
    }
    nav button.active {
      border-bottom: 3px solid var(--accent-color);
      color: var(--accent-color);
    }

    /* Conteneur pour les pages; chaque section occupe toute la largeur et
       est cachée par défaut sauf celle qui est active. */
    .tab-content {
      display: none;
      padding: 1em 2em;
    }
    .tab-content.active {
      display: block;
    }

    /* Style général des formulaires et tableaux */
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1em;
      margin-bottom: 1em;
      background-color: var(--secondary-color);
      padding: 1em;
      border-radius: 8px;
    }
    form label {
      margin-bottom: 0.2em;
      color: var(--accent-color);
      font-weight: bold;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 0.5em;
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      color: #000;
      box-sizing: border-box;
    }
    form textarea {
      resize: vertical;
      min-height: 80px;
    }
    form .full-row {
      grid-column: 1 / -1;
    }
    .btn {
      padding: 0.6em 1.2em;
      background-color: var(--accent-color);
      border: none;
      color: var(--text-color);
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    .btn:hover {
      background-color: #005a99;
    }
    .btn.small {
      padding: 0.4em 0.8em;
      font-size: 0.9em;
    }

    /* Amélioration de l'apparence des formulaires et éléments interactifs
       pour un rendu plus professionnel.  Les formulaires utilisent
       un fond légèrement translucide pour se distinguer du fond du
       conteneur, et les champs de type fichier sont explicitement
       stylés pour conserver un contraste élevé. */
    form {
      background-color: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--primary-color);
    }
    input[type="file"] {
      background-color: var(--light-bg);
      color: #000;
    }

    /* Personnalisation des cases à cocher pour les conditions afin
       qu’elles ressemblent à des boutons sélectionnables.  Chaque
       étiquette agit comme un bouton; lorsqu’un choix est coché,
       l’arrière‑plan passe à la couleur d’accent et le texte reste
       visible sur fond sombre. */
    #special-conditions label,
    #intervention-conditions label {
      display: flex;
      align-items: center;
      background-color: var(--primary-color);
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      padding: 0.3em 0.6em;
      color: var(--text-color);
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #special-conditions label input[type="checkbox"],
    #intervention-conditions label input[type="checkbox"] {
      margin-right: 0.3em;
    }
    #special-conditions label:hover,
    #intervention-conditions label:hover {
      background-color: var(--secondary-color);
    }
    #special-conditions input[type="checkbox"]:checked + span,
    #intervention-conditions input[type="checkbox"]:checked + span {
      color: var(--accent-color);
      font-weight: bold;
    }

    /* Tableau avec lignes alternées pour une meilleure lisibilité */
    table tbody tr:nth-child(even) {
      background-color: var(--primary-color);
    }
    table tbody tr:nth-child(odd) {
      background-color: var(--secondary-color);
    }

    /* Légère ombre portée sur les boutons pour les faire ressortir */
    .btn {
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
      background-color: var(--secondary-color);
      border: 1px solid var(--accent-color);
    }
    table thead {
      background-color: var(--primary-color);
    }
    table th, table td {
      padding: 0.5em;
      border: 1px solid var(--accent-color);
      text-align: left;
      color: var(--text-color);
    }
    table th {
      color: var(--accent-color);
    }
    .status-badge {
      display: inline-block;
      padding: 0.3em 0.6em;
      border-radius: 12px;
      color: var(--text-color);
      font-size: 0.8em;
      margin-right: 0.3em;
    }
    .status-en-attente { background-color: #9b59b6; }
    .status-approuvee { background-color: #27ae60; }
    .status-manque-info { background-color: #e67e22; }
    .status-en-attente-pieces { background-color: #d35400; }
    .status-a-ceduler { background-color: #f1c40f; color:#000; }
    .status-rejete { background-color: #c0392b; }
    .status-terminee { background-color: #2980b9; }

    /* Section KPI sous forme de cartes */
    .kpi-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
    }
    .kpi-card {
      flex: 1 1 200px;
      background-color: var(--secondary-color);
      border: 1px solid var(--accent-color);
      border-radius: 6px;
      padding: 1em;
      text-align: center;
    }
    .kpi-card h3 {
      margin: 0.2em 0;
      font-size: 1.1em;
      color: var(--accent-color);
    }
    .kpi-card p {
      margin: 0;
      font-size: 1.8em;
      font-weight: bold;
    }

    /* Boîte modale pour messages (manque d'information et rejet) */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: var(--secondary-color);
      padding: 1em;
      border-radius: 6px;
      width: 90%;
      max-width: 500px;
    }
    .modal-content h3 {
      margin-top: 0;
    }

    .flex-row {
      display: flex;
      gap: 0.5em;
    }

    /*
      Classes d'enveloppe pour donner aux sections un aspect professionnel
      similaire aux formulaires de changement de quart. Chaque section est
      encadrée dans un conteneur avec un en‑tête sombre, un trait
      accentué et un contenu sur fond plus clair. Ces classes permettent
      de reproduire la présentation soignée des pages "rapport de quart".
    */
    .page-wrapper {
      max-width: 1200px;
      margin: 2rem auto;
      background: var(--secondary-color);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .page-header {
      background: var(--primary-color);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      border-bottom: 3px solid var(--accent-color);
    }
    .page-header img {
      height: 40px;
      margin-right: 1rem;
    }
    .page-header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: var(--text-color);
    }
    .page-content {
      padding: 1.5rem;
    }
  </style>
</head>
<body>
  <nav>
    <button id="tab-home" class="active" onclick="showTab('home')">Accueil</button>
    <button id="tab-new" onclick="showTab('new')">Nouvelle demande</button>
    <button id="tab-approval" onclick="showTab('approval')">Demandes en approbation</button>
    <button id="tab-database" onclick="showTab('database')">Base de données</button>
    <button id="tab-worklog" onclick="showTab('worklog')">Journal de travail</button>
    <button id="tab-admin" onclick="showTab('admin')">Admin</button>
  </nav>

  <!-- Section Accueil avec tableau de bord KPI -->
  <section id="home" class="tab-content active">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Tableau de bord</h1>
      </div>
      <div class="page-content">
        <p>Bienvenue dans votre système GMAO. Utilisez les onglets pour créer et suivre les demandes de maintenance. Les indicateurs ci‑dessous reflètent l'état actuel.</p>
        <div class="kpi-cards" id="kpiContainer">
          <!-- KPI cards générées dynamiquement par JavaScript -->
        </div>
      </div>
    </div>
  </section>

  <!-- Section Nouvelle Demande -->
  <section id="new" class="tab-content">
    <!-- Enveloppe de présentation pour la section Nouvelle demande -->
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Nouvelle demande d'intervention</h1>
      </div>
      <div class="page-content">
        <form id="requestForm">
      <!-- Numéro de demande généré automatiquement -->
      <div>
        <label>NO. demande</label>
        <input type="text" id="req-id" readonly placeholder="Attribution automatique" />
      </div>
      <!-- Date -->
      <div>
        <label>Date</label>
        <input type="date" id="req-date" required />
      </div>
      <!-- Demandeur -->
      <div>
        <label>Demandeur</label>
        <input type="text" id="req-demandeur" required />
      </div>
      <!-- Département -->
      <div>
        <label>Département concerné</label>
        <select id="req-department" required></select>
      </div>
      <!-- Zone -->
      <div>
        <label>Zone</label>
        <select id="req-zone" required></select>
      </div>
      <!-- Équipement ou service -->
      <div class="full-row">
        <label>Équipement ou Service (description)</label>
        <input type="text" id="req-equipment-desc" placeholder="Description de l'équipement" />
      </div>
      <!-- NO. Équipement -->
      <div>
        <label>NO. Équipement</label>
        <input type="text" id="req-equipment-number" placeholder="Numéro de l'équipement" />
      </div>
      <!-- Priorisation -->
      <div>
        <label>Priorisation sommaire</label>
        <select id="req-priority" required></select>
      </div>
      <!-- Condition spéciale -->
      <div class="full-row">
        <label>Condition spéciale</label>
        <div class="flex-row" id="special-conditions">
          <!-- boutons générés via JS -->
        </div>
      </div>
      <!-- Condition d'intervention -->
      <div class="full-row">
        <label>Condition d'intervention</label>
        <div class="flex-row" id="intervention-conditions">
          <!-- boutons générés via JS -->
        </div>
      </div>
      <!-- Description courte -->
      <div class="full-row">
        <label>Description (250 caractères max)</label>
        <textarea id="req-description" maxlength="250" placeholder="Description concise"></textarea>
      </div>
      <!-- Bouton pour description longue -->
      <div class="full-row">
        <input type="checkbox" id="longDescToggle" />
        <label for="longDescToggle">Description plus longue (500 caractères)</label>
        <textarea id="req-description-long" maxlength="500" placeholder="Description détaillée (optionnelle)" style="display:none;"></textarea>
      </div>
      <!-- Ajout d'images ou plans -->
      <div class="full-row">
        <label>Ajouter des images ou plans (max 5)</label>
        <input type="file" id="req-images" accept="image/*" multiple />
      </div>
      <!-- Bouton envoyer -->
      <div class="full-row" style="text-align: right;">
        <button type="submit" class="btn">Envoyer la demande</button>
      </div>
        </form>
      </div> <!-- .page-content -->
    </div> <!-- .page-wrapper -->
  </section>

  <!-- Section Demandes en approbation -->
  <section id="approval" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Demandes en approbation</h1>
      </div>
      <div class="page-content">
        <p>Les demandes en attente d'approbation apparaissent ci‑dessous. Cliquez sur une action pour mettre à jour la demande.</p>
        <div id="approvalTableContainer"></div>
      </div> <!-- .page-content -->
    </div> <!-- .page-wrapper -->
  </section>

  <!-- Section Base de données -->
  <section id="database" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Base de données</h1>
      </div>
      <div class="page-content">
        <p>Recherche avancée dans toutes les demandes. Utilisez les filtres pour affiner vos résultats.</p>
        <form id="searchForm">
      <div>
        <label>Mot‑clé</label>
        <input type="text" id="search-keyword" placeholder="Recherche générale" />
      </div>
      <div>
        <label>Département</label>
        <select id="search-department">
          <option value="">Tous</option>
        </select>
      </div>
      <div>
        <label>Zone</label>
        <select id="search-zone">
          <option value="">Toutes</option>
        </select>
      </div>
      <div>
        <label>Priorité</label>
        <select id="search-priority">
          <option value="">Toutes</option>
        </select>
      </div>
      <div>
        <label>Statut</label>
        <select id="search-status">
          <option value="">Tous</option>
          <option value="en-attente">En attente</option>
          <option value="approuvee">Approuvée</option>
          <option value="manque-info">Manque info</option>
          <option value="en-attente-pieces">En attente pièces</option>
          <option value="a-ceduler">À cédule</option>
          <option value="rejete">Rejetée</option>
          <option value="terminee">Terminée</option>
        </select>
      </div>
      <div class="full-row" style="text-align: right;">
        <button type="button" class="btn" onclick="performSearch()">Rechercher</button>
      </div>
    </form>
        <div id="databaseResults"></div>
      </div> <!-- .page-content -->
    </div> <!-- .page-wrapper -->
  </section>

  <!-- Section Journal de travail -->
  <section id="worklog" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Journal de travail</h1>
      </div>
      <div class="page-content">
        <p>Les techniciens peuvent saisir ici le compte‑rendu d’un bon de travail (BT) ou demande de travail (DT) à l’aide du numéro unique.</p>
        <form id="worklogForm">
      <div>
        <label>Numéro de demande (BT/DT)</label>
        <input type="text" id="worklog-id" required />
      </div>
      <div>
        <label>Statut du travail</label>
        <select id="worklog-status" required>
          <option value="terminee">Complété</option>
          <option value="annulee">Annulé</option>
          <option value="reportee">À reporter</option>
          <option value="manque-pieces">Pas terminé (manque pièces)</option>
          <option value="a-continuer">À continuer</option>
          <option value="autre">Autres</option>
        </select>
      </div>
      <div class="full-row">
        <label>Description du travail effectué</label>
        <textarea id="worklog-description" maxlength="500" placeholder="Détails du travail"></textarea>
      </div>
      <div class="full-row">
        <label>Ajouter des images supplémentaires</label>
        <input type="file" id="worklog-images" accept="image/*" multiple />
      </div>
      <div class="full-row" style="text-align: right;">
        <button type="submit" class="btn">Envoyer compte‑rendu</button>
      </div>
        </form>
        <div id="worklogMessage"></div>
      </div> <!-- .page-content -->
    </div> <!-- .page-wrapper -->
  </section>

  <!-- Section Admin -->
  <section id="admin" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Administration</h1>
      </div>
      <div class="page-content">
        <p>Gestion des valeurs des menus déroulants et configuration générale du système.</p>
        <form id="adminForm">
      <div class="full-row">
        <label>Départements (séparés par des virgules)</label>
        <input type="text" id="admin-departments" />
      </div>
      <div class="full-row">
        <label>Zones (séparées par des virgules)</label>
        <input type="text" id="admin-zones" />
      </div>
      <div class="full-row">
        <label>Priorités (séparées par des virgules)</label>
        <input type="text" id="admin-priorities" />
      </div>
      <div class="full-row" style="text-align: right;">
        <button type="button" class="btn" onclick="saveAdminSettings()">Enregistrer les paramètres</button>
      </div>
        </form>
        <p><small>Les modifications prennent effet immédiatement et sont stockées localement.</small></p>
      </div> <!-- .page-content -->
    </div> <!-- .page-wrapper -->
  </section>

  <!-- Modale pour saisir des commentaires (manque d'information ou rejet) -->
  <div class="modal" id="commentModal">
    <div class="modal-content">
      <h3 id="modalTitle">Commentaire</h3>
      <textarea id="modalComment" maxlength="250" style="width:100%; height:100px; margin-bottom:1em;"></textarea>
      <div style="text-align:right;">
        <button class="btn small" onclick="closeModal(false)">Annuler</button>
        <button class="btn small" onclick="closeModal(true)">Valider</button>
      </div>
    </div>
  </div>

  <script>
    /*
      Fonctions utilitaires pour la gestion des données de la GMAO.  Les demandes
      sont stockées dans localStorage sous forme de tableau d’objets.  Chaque
      objet représente une demande avec les propriétés suivantes :
        id, date, demandeur, department, zone, equipmentDesc, equipmentNumber,
        priority, specialConditions (array), interventionConditions (array),
        description, descriptionLong, images (array d’objets { name, data }),
        status (en-attente, approuvee, manque-info, en-attente-pieces, a-ceduler,
        rejete, terminee),
        comments (array d’historiques) et worklogs (array).  Les paramètres
      d’administration (listes déroulantes) sont stockés sous la clé gmaoConfig.
    */

    /** Récupère le tableau de demandes depuis localStorage. */
    function getRequests() {
      const data = localStorage.getItem('gmaoRequests');
      return data ? JSON.parse(data) : [];
    }
    /** Sauvegarde le tableau de demandes dans localStorage. */
    function saveRequests(requests) {
      localStorage.setItem('gmaoRequests', JSON.stringify(requests));
    }
    /** Récupère la configuration (listes de départements, zones, priorités). */
    function getConfig() {
      const defaultConfig = {
        departments: ['Mécanique','Électrique','Opération','Technique','Projet','Formation'],
        zones: ['Zone A','Zone B','Zone C','Zone D'],
        priorities: ['Priorité 1 (urgent)','Priorité 2 (court terme)','Priorité 3 (à planifier)','Priorité 4 (projet)'],
        specialConditions: ['Espace clos','Travail à chaud','Levage','Nacelle','Autres'],
        interventionConditions: ['En arrêt','En fonction','En shutdown','Autres']
      };
      const data = localStorage.getItem('gmaoConfig');
      return data ? { ...defaultConfig, ...JSON.parse(data) } : defaultConfig;
    }
    /** Sauvegarde la configuration dans localStorage. */
    function saveConfig(config) {
      localStorage.setItem('gmaoConfig', JSON.stringify(config));
    }

    /** Génère un identifiant unique basé sur la date et un compteur. */
    function generateUniqueId() {
      const prefix = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
      let counter = parseInt(localStorage.getItem('gmaoCounter') || '0', 10);
      counter += 1;
      localStorage.setItem('gmaoCounter', String(counter));
      return `${prefix}-${counter}`;
    }

    /** Rafraîchit les menus déroulants selon la configuration. */
    function populateDropdowns() {
      const config = getConfig();
      const depSelect = document.getElementById('req-department');
      const zoneSelect = document.getElementById('req-zone');
      const prioSelect = document.getElementById('req-priority');
      const searchDep = document.getElementById('search-department');
      const searchZone = document.getElementById('search-zone');
      const searchPri = document.getElementById('search-priority');
      // Reset existing options
      [depSelect, zoneSelect, prioSelect].forEach(sel => sel.innerHTML = '');
      config.departments.forEach(dep => {
        const opt1 = document.createElement('option'); opt1.value = dep; opt1.textContent = dep;
        depSelect.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = dep; opt2.textContent = dep;
        searchDep.appendChild(opt2);
      });
      config.zones.forEach(zone => {
        const opt1 = document.createElement('option'); opt1.value = zone; opt1.textContent = zone;
        zoneSelect.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = zone; opt2.textContent = zone;
        searchZone.appendChild(opt2);
      });
      config.priorities.forEach(prio => {
        const opt1 = document.createElement('option'); opt1.value = prio; opt1.textContent = prio;
        prioSelect.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = prio; opt2.textContent = prio;
        searchPri.appendChild(opt2);
      });
      // Spécial & intervention conditions
      const specialContainer = document.getElementById('special-conditions');
      specialContainer.innerHTML = '';
      config.specialConditions.forEach(cond => {
        const label = document.createElement('label');
        label.style.marginRight = '0.5em';
        const input = document.createElement('input');
        input.type = 'checkbox'; input.value = cond;
        input.id = 'spec-' + cond;
        label.appendChild(input);
        const span = document.createElement('span');
        span.textContent = ' ' + cond;
        label.appendChild(span);
        specialContainer.appendChild(label);
      });
      const intervContainer = document.getElementById('intervention-conditions');
      intervContainer.innerHTML = '';
      config.interventionConditions.forEach(cond => {
        const label = document.createElement('label');
        label.style.marginRight = '0.5em';
        const input = document.createElement('input');
        input.type = 'checkbox'; input.value = cond;
        input.id = 'interv-' + cond;
        label.appendChild(input);
        const span = document.createElement('span');
        span.textContent = ' ' + cond;
        label.appendChild(span);
        intervContainer.appendChild(label);
      });
    }

    /** Met à jour les cartes KPI sur la page d’accueil. */
    function updateKpi() {
      const requests = getRequests();
      const counts = {
        total: requests.length,
        enAttente: requests.filter(r => r.status === 'en-attente').length,
        approuvees: requests.filter(r => r.status === 'approuvee').length,
        manqueInfo: requests.filter(r => r.status === 'manque-info').length,
        attentePieces: requests.filter(r => r.status === 'en-attente-pieces').length,
        aCeduler: requests.filter(r => r.status === 'a-ceduler').length,
        rejetees: requests.filter(r => r.status === 'rejete').length,
        terminees: requests.filter(r => r.status === 'terminee').length
      };
      const kpiContainer = document.getElementById('kpiContainer');
      kpiContainer.innerHTML = '';
      const kpis = [
        { title: 'Nombre total de demandes', value: counts.total },
        { title: 'En attente', value: counts.enAttente },
        { title: 'Approuvées', value: counts.approuvees },
        { title: 'Manque d\'info', value: counts.manqueInfo },
        { title: 'En attente de pièces', value: counts.attentePieces },
        { title: 'À cédule', value: counts.aCeduler },
        { title: 'Rejetées', value: counts.rejetees },
        { title: 'Terminées', value: counts.terminees }
      ];
      kpis.forEach(k => {
        const card = document.createElement('div');
        card.className = 'kpi-card';
        const h3 = document.createElement('h3'); h3.textContent = k.title;
        const p = document.createElement('p'); p.textContent = k.value;
        card.appendChild(h3);
        card.appendChild(p);
        kpiContainer.appendChild(card);
      });
    }

    /** Affiche la section de l’onglet sélectionné. */
    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
      if (tab === 'approval') renderApprovalTable();
      if (tab === 'database') performSearch();
      if (tab === 'home') updateKpi();
    }

    /** Convertit des fichiers image en Base64 pour stockage. */
    function processFiles(fileInput) {
      return new Promise(resolve => {
        const files = Array.from(fileInput.files).slice(0, 5);
        const promises = files.map(file => {
          return new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => res({ name: file.name, data: reader.result });
            reader.readAsDataURL(file);
          });
        });
        Promise.all(promises).then(resolve);
      });
    }

    /** Soumission du formulaire de nouvelle demande. */
    document.getElementById('requestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = generateUniqueId();
      const date = document.getElementById('req-date').value;
      const demandeur = document.getElementById('req-demandeur').value.trim();
      const department = document.getElementById('req-department').value;
      const zone = document.getElementById('req-zone').value;
      const equipmentDesc = document.getElementById('req-equipment-desc').value.trim();
      const equipmentNumber = document.getElementById('req-equipment-number').value.trim();
      const priority = document.getElementById('req-priority').value;
      const specialConditions = Array.from(document.querySelectorAll('#special-conditions input:checked')).map(i => i.value);
      const interventionConditions = Array.from(document.querySelectorAll('#intervention-conditions input:checked')).map(i => i.value);
      const description = document.getElementById('req-description').value.trim();
      const descriptionLong = document.getElementById('longDescToggle').checked ? document.getElementById('req-description-long').value.trim() : '';
      const images = await processFiles(document.getElementById('req-images'));
      const requests = getRequests();
      requests.push({
        id,
        date,
        demandeur,
        department,
        zone,
        equipmentDesc,
        equipmentNumber,
        priority,
        specialConditions,
        interventionConditions,
        description,
        descriptionLong,
        images,
        status: 'en-attente',
        comments: [],
        worklogs: []
      });
      saveRequests(requests);
      alert('Demande envoyée!');
      e.target.reset();
      document.getElementById('req-id').value = '';
      document.getElementById('req-date').focus();
      updateKpi();
    });

    /** Réagit à la case « description plus longue ». */
    document.getElementById('longDescToggle').addEventListener('change', (e) => {
      document.getElementById('req-description-long').style.display = e.target.checked ? 'block' : 'none';
    });

    /** Affiche le tableau des demandes en attente d'approbation. */
    function renderApprovalTable() {
      const container = document.getElementById('approvalTableContainer');
      const requests = getRequests().filter(r => r.status === 'en-attente');
      if (requests.length === 0) {
        container.innerHTML = '<p>Aucune demande en attente.</p>';
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      ['NO','Date','Demandeur','Département','Zone','Priorité','Statut','Actions'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      const tbody = document.createElement('tbody');
      requests.forEach((req, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${req.id}</td><td>${req.date}</td><td>${req.demandeur}</td><td>${req.department}</td><td>${req.zone}</td><td>${req.priority}</td>`;
        // statut
        const statusTd = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'status-badge status-' + req.status;
        badge.textContent = 'En attente';
        statusTd.appendChild(badge);
        tr.appendChild(statusTd);
        // actions
        const actionsTd = document.createElement('td');
        actionsTd.style.whiteSpace = 'nowrap';
        const actions = [
          { label: 'Approuver', status: 'approuvee' },
          { label: 'Manque info', status: 'manque-info' },
          { label: 'Attente pièces', status: 'en-attente-pieces' },
          { label: 'À cédule', status: 'a-ceduler' },
          { label: 'Rejeter', status: 'rejete' }
        ];
        actions.forEach(action => {
          const btn = document.createElement('button');
          btn.textContent = action.label;
          btn.className = 'btn small';
          btn.onclick = () => handleAction(req.id, action.status);
          actionsTd.appendChild(btn);
        });
        tr.appendChild(actionsTd);
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    /** Traitement des actions dans la table d’approbation. */
    function handleAction(id, newStatus) {
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      if (newStatus === 'manque-info' || newStatus === 'rejete') {
        // ouvrir modale pour message
        modalState.requestId = id;
        modalState.newStatus = newStatus;
        document.getElementById('modalTitle').textContent = newStatus === 'manque-info' ? 'Message de manque d\'information' : 'Raison du rejet';
        document.getElementById('modalComment').value = '';
        document.getElementById('commentModal').style.display = 'flex';
      } else {
        req.status = newStatus;
        req.comments.push({ date: new Date().toISOString(), status: newStatus, comment: '' });
        saveRequests(requests);
        renderApprovalTable();
        updateKpi();
      }
    }
    // Etat temporaire pour la modale
    const modalState = { requestId: null, newStatus: null };
    /** Ferme la modale.  Si confirm = true, enregistre le commentaire et change le statut. */
    function closeModal(confirm) {
      document.getElementById('commentModal').style.display = 'none';
      if (confirm) {
        const comment = document.getElementById('modalComment').value.trim();
        const requests = getRequests();
        const req = requests.find(r => r.id === modalState.requestId);
        if (req) {
          req.status = modalState.newStatus;
          req.comments.push({ date: new Date().toISOString(), status: modalState.newStatus, comment });
          saveRequests(requests);
        }
      }
      renderApprovalTable();
      updateKpi();
    }

    /** Recherche et filtrage dans la base de données. */
    function performSearch() {
      const keyword = document.getElementById('search-keyword').value.trim().toLowerCase();
      const dep = document.getElementById('search-department').value;
      const zone = document.getElementById('search-zone').value;
      const priority = document.getElementById('search-priority').value;
      const status = document.getElementById('search-status').value;
      const requests = getRequests().filter(r => {
        const matchKeyword = keyword === '' || Object.values(r).some(val => typeof val === 'string' && val.toLowerCase().includes(keyword));
        const matchDep = dep === '' || r.department === dep;
        const matchZone = zone === '' || r.zone === zone;
        const matchPrio = priority === '' || r.priority === priority;
        const matchStatus = status === '' || r.status === status;
        return matchKeyword && matchDep && matchZone && matchPrio && matchStatus;
      });
      const container = document.getElementById('databaseResults');
      if (requests.length === 0) {
        container.innerHTML = '<p>Aucun résultat.</p>';
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      ['NO','Date','Demandeur','Département','Zone','Priorité','Statut'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      const tbody = document.createElement('tbody');
      requests.forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${req.id}</td><td>${req.date}</td><td>${req.demandeur}</td><td>${req.department}</td><td>${req.zone}</td><td>${req.priority}</td>`;
        const statusTd = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'status-badge status-' + req.status;
        const labelMap = {
          'en-attente': 'En attente',
          'approuvee': 'Approuvée',
          'manque-info': 'Manque info',
          'en-attente-pieces': 'Attente pièces',
          'a-ceduler': 'À cédule',
          'rejete': 'Rejetée',
          'terminee': 'Terminée'
        };
        badge.textContent = labelMap[req.status] || req.status;
        statusTd.appendChild(badge);
        tr.appendChild(statusTd);
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    /** Envoi du compte‑rendu de travail. */
    document.getElementById('worklogForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('worklog-id').value.trim();
      const status = document.getElementById('worklog-status').value;
      const description = document.getElementById('worklog-description').value.trim();
      const images = await processFiles(document.getElementById('worklog-images'));
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      const messageContainer = document.getElementById('worklogMessage');
      if (!req) {
        messageContainer.textContent = 'Demande introuvable.';
        messageContainer.style.color = '#e74c3c';
        return;
      }
      // Mettre à jour le statut en terminée sauf si autres statuts spécifiques
      if (['annulee','reportee','manque-pieces','a-continuer','autre'].includes(status)) {
        // On peut garder le statut original et enregistrer le compte rendu séparément
      } else {
        req.status = 'terminee';
      }
      req.worklogs.push({
        date: new Date().toISOString(),
        status,
        description,
        images
      });
      saveRequests(requests);
      messageContainer.textContent = 'Compte‑rendu enregistré.';
      messageContainer.style.color = '#27ae60';
      e.target.reset();
      updateKpi();
    });

    /** Sauvegarde des paramètres dans la section Admin. */
    function saveAdminSettings() {
      const departments = document.getElementById('admin-departments').value.split(',').map(s => s.trim()).filter(Boolean);
      const zones = document.getElementById('admin-zones').value.split(',').map(s => s.trim()).filter(Boolean);
      const priorities = document.getElementById('admin-priorities').value.split(',').map(s => s.trim()).filter(Boolean);
      const config = getConfig();
      if (departments.length) config.departments = departments;
      if (zones.length) config.zones = zones;
      if (priorities.length) config.priorities = priorities;
      saveConfig(config);
      populateDropdowns();
      alert('Paramètres enregistrés.');
    }

    /** Initialisation de la page au chargement. */
    window.addEventListener('DOMContentLoaded', () => {
      populateDropdowns();
      updateKpi();
      // Pré-remplir les champs admin avec la configuration actuelle
      const config = getConfig();
      document.getElementById('admin-departments').value = config.departments.join(', ');
      document.getElementById('admin-zones').value = config.zones.join(', ');
      document.getElementById('admin-priorities').value = config.priorities.join(', ');
      // Générer l’ID dans le champ lecture seule lors du focus
      document.getElementById('req-date').addEventListener('focus', () => {
        document.getElementById('req-id').value = generateUniqueId();
      }, { once: true });
    });
  </script>
</body>
</html>
