<!--
  GMAO (Gestion de Maintenance Assistée par Ordinateur) – Application web

  Cette page est une application autonome permettant de gérer des demandes d'intervention
  et de suivre l’avancement des travaux. Elle adopte le style des fichiers existants
  dans le dépôt (palette de couleurs bleu foncé et accent bleu clair) et fonctionne sans
  serveur en utilisant le stockage local (localStorage) pour sauvegarder les données
  jusqu’à ce qu’un serveur backend soit disponible.  Le code est commenté en français
  pour en faciliter l’adaptation.  Les sections principales sont :
    • Accueil : tableau de bord et indicateurs (KPI)
    • Nouvelle demande : formulaire pour créer une demande unique
    • Demandes en approbation : liste des demandes en attente avec actions
    • Base de données : recherche et filtrage de toutes les demandes
    • Journal de travail : saisie des comptes‑rendus par les corps de métier
    • Admin : gestion des listes déroulantes et paramètres

  Cette version utilise uniquement du HTML, CSS et JavaScript. Toutes les données
  sont enregistrées dans localStorage sous la clé "gmaoRequests" (tableau d’objets)
  et "gmaoConfig" (paramètres).  Lorsqu’un serveur sera disponible, ces appels
  pourront être remplacés par des requêtes API.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GMAO – Gestion des demandes de maintenance</title>
  <style>
    /*
      Variables de couleur pour s’aligner sur le thème existant
      (bleu foncé, bleu moyen et bleu clair).  La couleur principale sert
      de fond; la couleur secondaire pour les en‑têtes et l’accent pour
      les boutons et éléments interactifs.  Le texte est blanc pour un
      contraste élevé.
    */
    :root {
      --primary-color: #253746;
      --secondary-color: #324e67;
      --accent-color: #0078c8;
      --text-color: #ffffff;
      --light-bg: #f5f5f5;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--primary-color);
      color: var(--text-color);
      overflow-y: scroll;
    }

    h1, h2, h3 {
      margin: 0.5em 0;
      color: var(--accent-color);
    }

    /* Barre de navigation horizontale en haut de la page.  Chaque onglet
       est un bouton qui appelle showTab() pour afficher la section
       correspondante.  Les onglets actifs sont soulignés. */
    nav {
      display: flex;
      background-color: var(--secondary-color);
      border-bottom: 2px solid var(--accent-color);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav button {
      flex: 1;
      padding: 1em;
      background: none;
      border: none;
      color: var(--text-color);
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    nav button:hover {
      background-color: var(--primary-color);
    }
    nav button.active {
      border-bottom: 3px solid var(--accent-color);
      color: var(--accent-color);
    }

    /* Conteneur pour les pages; chaque section occupe toute la largeur et
       est cachée par défaut sauf celle qui est active. */
    .tab-content {
      display: none;
      padding: 1em 2em;
    }
    .tab-content.active {
      display: block;
    }

    /* Style général des formulaires et tableaux */
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1em;
      margin-bottom: 1em;
      background-color: var(--secondary-color);
      padding: 1em;
      border-radius: 8px;
    }
    form label {
      margin-bottom: 0.2em;
      color: var(--accent-color);
      font-weight: bold;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 0.5em;
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      color: #000;
      box-sizing: border-box;
    }
    form textarea {
      resize: vertical;
      min-height: 80px;
    }
    form .full-row {
      grid-column: 1 / -1;
    }
    .btn {
      padding: 0.6em 1.2em;
      background-color: var(--accent-color);
      border: none;
      color: var(--text-color);
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    .btn:hover {
      background-color: #005a99;
    }
    .btn.small {
      padding: 0.4em 0.8em;
      font-size: 0.9em;
    }

    /* Amélioration de l'apparence des formulaires et éléments interactifs
       pour un rendu plus professionnel.  Les formulaires utilisent
       un fond légèrement translucide pour se distinguer du fond du
       conteneur, et les champs de type fichier sont explicitement
       stylés pour conserver un contraste élevé. */
    form {
      background-color: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--primary-color);
    }
    input[type="file"] {
      background-color: var(--light-bg);
      color: #000;
    }

    /* Personnalisation des cases à cocher pour les conditions afin
       qu’elles ressemblent à des boutons sélectionnables.  Chaque
       étiquette agit comme un bouton; lorsqu’un choix est coché,
       l’arrière‑plan passe à la couleur d’accent et le texte reste
       visible sur fond sombre. */
    #special-conditions label,
    #intervention-conditions label {
      display: flex;
      align-items: center;
      background-color: var(--primary-color);
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      padding: 0.3em 0.6em;
      color: var(--text-color);
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #special-conditions label input[type="checkbox"],
    #intervention-conditions label input[type="checkbox"] {
      margin-right: 0.3em;
    }
    #special-conditions label:hover,
    #intervention-conditions label:hover {
      background-color: var(--secondary-color);
    }
    #special-conditions input[type="checkbox"]:checked + span,
    #intervention-conditions input[type="checkbox"]:checked + span {
      color: var(--accent-color);
      font-weight: bold;
    }

    /* Tableau avec lignes alternées pour une meilleure lisibilité */
    table tbody tr:nth-child(even) {
      background-color: var(--primary-color);
    }
    table tbody tr:nth-child(odd) {
      background-color: var(--secondary-color);
    }

    /* Légère ombre portée sur les boutons pour les faire ressortir */
    .btn {
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
      background-color: var(--secondary-color);
      border: 1px solid var(--accent-color);
    }
    table thead {
      background-color: var(--primary-color);
    }
    table th, table td {
      padding: 0.5em;
      border: 1px solid var(--accent-color);
      text-align: left;
      color: var(--text-color);
    }
    table th {
      color: var(--accent-color);
    }
    .status-badge {
      display: inline-block;
      padding: 0.3em 0.6em;
      border-radius: 12px;
      color: var(--text-color);
      font-size: 0.8em;
      margin-right: 0.3em;
    }
    .status-en-attente { background-color: #9b59b6; }
    .status-approuvee { background-color: #27ae60; }
    .status-manque-info { background-color: #e67e22; }
    .status-en-attente-pieces { background-color: #d35400; }
    .status-a-ceduler { background-color: #f1c40f; color:#000; }
    .status-rejete { background-color: #c0392b; }
    .status-terminee { background-color: #2980b9; }

    /* Section KPI sous forme de cartes */
    .kpi-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
    }
    .kpi-card {
      flex: 1 1 200px;
      background-color: var(--secondary-color);
      border: 1px solid var(--accent-color);
      border-radius: 6px;
      padding: 1em;
      text-align: center;
    }
    .kpi-card h3 {
      margin: 0.2em 0;
      font-size: 1.1em;
      color: var(--accent-color);
    }
    .kpi-card p {
      margin: 0;
      font-size: 1.8em;
      font-weight: bold;
    }

    /* Boîte modale pour messages (manque d'information et rejet) */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: var(--secondary-color);
      padding: 1em;
      border-radius: 6px;
      width: 90%;
      max-width: 500px;
    }
    .modal-content h3 {
      margin-top: 0;
    }

    .flex-row {
      display: flex;
      gap: 0.5em;
    }

    /*
      Classes d'enveloppe pour donner aux sections un aspect professionnel
      similaire aux formulaires de changement de quart. Chaque section est
      encadrée dans un conteneur avec un en‑tête sombre, un trait
      accentué et un contenu sur fond plus clair. Ces classes permettent
      de reproduire la présentation soignée des pages "rapport de quart".
    */
    .page-wrapper {
      max-width: 1200px;
      margin: 2rem auto;
      background: var(--secondary-color);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .page-header {
      background: var(--primary-color);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      border-bottom: 3px solid var(--accent-color);
    }
    .page-header img {
      height: 40px;
      margin-right: 1rem;
    }
    .page-header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: var(--text-color);
    }
    .page-content {
      padding: 1.5rem;
    }
  </style>
</head>
<body>
  <!-- Page de connexion, affichée avant que l'utilisateur ne se connecte. -->
  <div id="login-container" style="display:none;">
    <div class="page-wrapper">
      <div class="page-header">
        <h1>Connexion GMAO</h1>
      </div>
      <div class="page-content">
        <form onsubmit="event.preventDefault(); login();" style="max-width:400px;margin:auto;">
          <label>Nom d'utilisateur :</label>
          <input type="text" id="login-user" required />
          <label>Mot de passe :</label>
          <input type="password" id="login-pass" required />
          <button type="submit" class="btn" style="margin-top:1em;">Se connecter</button>
          <p id="login-error" style="color:#e74c3c;margin-top:0.5em;"></p>
        </form>
      </div>
    </div>
  </div>
  <nav style="display:none;">
    <!-- Chaque bouton possède un attribut data-roles indiquant les rôles autorisés. -->
    <button id="tab-home" class="active" data-roles="all" onclick="showTab('home')">Accueil</button>
    <button id="tab-new" data-roles="all" onclick="showTab('new')">Nouvelle demande</button>
    <button id="tab-approval" data-roles="admin,planificateur" onclick="showTab('approval')">Demandes en approbation</button>
    <button id="tab-edit" data-roles="admin,planificateur" onclick="showTab('edit')">Modification de demande</button>
    <button id="tab-planner" data-roles="admin,planificateur" onclick="showTab('planner')">Planificateur</button>
    <button id="tab-backlogs" data-roles="all" onclick="showTab('backlogs')">Backlogs</button>
    <button id="tab-worklog" data-roles="all" onclick="showTab('worklog')">Journal de travail</button>
    <button id="tab-admin" data-roles="admin" onclick="showTab('admin')">Admin</button>
    <!-- Bouton de déconnexion, affiché uniquement lorsque l'utilisateur est connecté -->
    <button id="logout-btn" data-roles="all" style="display:none;" onclick="logout()">Déconnexion</button>
  </nav>

  <!-- Section Accueil avec tableau de bord KPI -->
  <section id="home" class="tab-content active">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Tableau de bord</h1>
      </div>
      <div class="page-content">
        <p>Bienvenue dans votre système GMAO. Utilisez les onglets pour créer et suivre les demandes de maintenance. Les indicateurs ci‑dessous reflètent l'état actuel.</p>
        <div class="kpi-cards" id="kpiContainer">
          <!-- Les cartes KPI seront générées dynamiquement -->
        </div>
      </div>
    </div>
  </section>

  <!-- Section Nouvelle demande -->
  <section id="new" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Nouvelle demande</h1>
      </div>
      <div class="page-content">
        <form id="request-form" onsubmit="event.preventDefault(); submitRequest();">
          <label>ID</label>
          <input id="req-id" readonly="readonly" type="text" />
          <label>Date</label>
          <input id="req-date" required="required" type="date" />
          <label>Demandeur</label>
          <input id="req-demandeur" required="required" type="text" />
          <label>Département concerné</label>
          <select id="req-department" required="required"></select>
          <label>Zone</label>
          <select id="req-zone" required="required"></select>
          <label>Équipement ou Service (description)</label>
          <input id="req-equipment-desc" type="text" />
          <label>NO. Équipement</label>
          <input id="req-equipment-number" type="text" />
          <label>Métier (corps de métier)</label>
          <select id="req-trade"></select>
          <label>Heures prévues</label>
          <input id="req-hours" min="0" step="0.25" type="number" />
          <label>Priorisation</label>
          <select id="req-priority" required="required"></select>
          <div class="full-row" id="special-conditions"></div>
          <div class="full-row" id="intervention-conditions"></div>
          <label>Description (250 caractères max)</label>
          <textarea id="req-description" maxlength="250" rows="3"></textarea>
          <label><input id="longDescToggle" type="checkbox" /> Description plus longue (500 caractères max)</label>
          <textarea id="req-description-long" maxlength="500" rows="4" style="display:none;"></textarea>
          <label>Ajouter des images / plans (max 5)</label>
          <input accept="image/*" id="req-images" multiple="multiple" type="file" />
          <button class="btn full-row" type="submit">Envoyer nouvelle demande en approbation</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Section Demandes en approbation -->
  <section id="approval" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Demandes en approbation</h1>
      </div>
      <div class="page-content">
        <table id="approvalTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Demandeur</th>
              <th>Département</th>
              <th>Zone</th>
              <th>Équipement</th>
              <th>Priorité</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modale pour manque d'information -->
    <div class="modal" id="infoModal">
      <div class="modal-content">
        <h3>Manque d'information</h3>
        <p>Veuillez indiquer les informations supplémentaires demandées :</p>
        <textarea id="infoMessage" rows="4" style="width:100%;"></textarea>
        <div class="flex-row" style="margin-top: 0.5em;">
          <button class="btn" onclick="sendInfoRequest()">Envoyer au demandeur</button>
          <button class="btn" onclick="closeModal('infoModal')">Annuler</button>
        </div>
      </div>
    </div>
    <!-- Modale pour rejet -->
    <div class="modal" id="rejectModal">
      <div class="modal-content">
        <h3>Rejeter la demande</h3>
        <p>Raison du rejet :</p>
        <textarea id="rejectMessage" rows="4" style="width:100%;"></textarea>
        <div class="flex-row" style="margin-top: 0.5em;">
          <button class="btn" onclick="sendReject()">Rejeter</button>
          <button class="btn" onclick="closeModal('rejectModal')">Annuler</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Modification de demande -->
  <section id="edit" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Modification de demande</h1>
      </div>
      <div class="page-content">
        <p>Entrez l'ID de la demande à modifier :
          <input id="edit-id-input" style="width:100px;" type="text" />
          <button class="btn" onclick="loadEditRequest()">Charger</button>
        </p>
        <div id="editSection" style="display:none;">
          <form id="edit-form" onsubmit="event.preventDefault(); saveEdit();">
            <label>ID</label>
            <input id="edit-id" readonly="readonly" type="text" />
            <label>Date</label>
            <input id="edit-date" required="required" type="date" />
            <label>Demandeur</label>
            <input id="edit-demandeur" required="required" type="text" />
            <label>Département</label>
            <select id="edit-department" required="required"></select>
            <label>Zone</label>
            <select id="edit-zone" required="required"></select>
            <label>Métier</label>
            <select id="edit-trade"></select>
            <label>Heures prévues</label>
            <input id="edit-hours" min="0" step="0.25" type="number" />
            <label>Équipement/Service</label>
            <input id="edit-equipment-desc" type="text" />
            <label>NO. Équipement</label>
            <input id="edit-equipment-number" type="text" />
            <label>Priorité</label>
            <select id="edit-priority" required="required"></select>
            <div class="full-row" id="edit-special-conditions">
              <!-- options générées dynamiquement -->
            </div>
            <div class="full-row" id="edit-intervention-conditions">
              <!-- options générées dynamiquement -->
            </div>
            <label>Description</label>
            <textarea id="edit-description" maxlength="250" rows="3"></textarea>
            <label><input id="edit-longDescToggle" type="checkbox" /> Description plus longue</label>
            <textarea id="edit-description-long" maxlength="500" rows="4" style="display:none;"></textarea>
            <label>Ajouter des images</label>
            <input accept="image/*" id="edit-images" multiple="multiple" type="file" />
            <button class="btn" type="submit">Enregistrer les modifications</button>
            <button class="btn" onclick="reopenRequest()" type="button">Réouvrir demande</button>
            <button class="btn" onclick="printRequest()" type="button">Imprimer en PDF</button>
            <div class="full-row" id="editMessage"></div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Backlogs -->
  <section id="backlogs" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Backlogs</h1>
      </div>
      <div class="page-content">
        <div style="display:flex;flex-wrap:wrap;gap:1em;">
          <input placeholder="Rechercher par ID" id="search-id" style="flex:1;" type="text" />
          <input placeholder="Mot-clé" id="search-keyword" style="flex:2;" type="text" />
          <input placeholder="Demandeur" id="search-demandeur" style="flex:1;" type="text" />
          <label>Date de début
            <input id="search-date-start" type="date" />
          </label>
          <label>Date de fin
            <input id="search-date-end" type="date" />
          </label>
          <select id="search-department"><option value="">--Département--</option></select>
          <select id="search-zone"><option value="">--Zone--</option></select>
          <select id="search-trade"><option value="">--Métier--</option></select>
          <select id="search-priority"><option value="">--Priorité--</option></select>
          <select id="search-status">
            <option value="">--Statut--</option>
            <option value="en-attente">En attente</option>
            <option value="approuvee">Approuvée</option>
            <option value="manque-info">Manque info</option>
            <option value="en-attente-pieces">Attente pièces</option>
            <option value="a-ceduler">À cédule</option>
            <option value="rejete">Rejetée</option>
            <option value="terminee">Terminée</option>
          </select>
          <button class="btn" onclick="performSearch()">Rechercher</button>
        </div>
        <table id="databaseTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Demandeur</th>
              <th>Département</th>
              <th>Zone</th>
              <th>Équipement</th>
              <th>Métier</th>
              <th>Priorité</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Section Planificateur -->
  <section id="planner" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Planificateur hebdomadaire</h1>
      </div>
      <div class="page-content">
        <div id="plannerTable"></div>
        <button class="btn" onclick="exportPlannerCSV()">Exporter en CSV</button>
      </div>
    </div>
  </section>

  <!-- Section Journal de travail -->
  <section id="worklog" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Journal de travail</h1>
      </div>
      <div class="page-content">
        <p>Entrez le numéro de la demande (DT) ou bon de travail (BT) :
          <input id="worklog-id" style="width:100px;" type="text" />
          <button class="btn" onclick="loadWorklogRequest()">Charger</button>
        </p>
        <div id="worklogSection" style="display:none;">
          <form id="worklog-form" onsubmit="event.preventDefault(); submitWorklog();">
            <label>Date du travail :</label>
            <input id="worklog-date" required="required" type="date" />
            <label>Statut du travail :</label>
            <select id="worklog-status" required="required">
              <option value="terminee">Complété</option>
              <option value="annulee">Annulé</option>
              <option value="a-reporter">À reporter</option>
              <option value="manque-pieces">Pas terminé - manque pièces</option>
              <option value="a-continuer">À continuer</option>
              <option value="autre">Autres</option>
            </select>
            <label>Description du travail effectué :</label>
            <textarea id="worklog-description" rows="4" maxlength="500"></textarea>
            <label>Ajouter des photos (facultatif) :</label>
            <input accept="image/*" id="worklog-images" multiple="multiple" type="file" />
            <button class="btn" type="submit">Soumettre</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Admin -->
  <section id="admin" class="tab-content">
    <div class="page-wrapper">
      <div class="page-header">
        <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&height=64&name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png" />
        <h1>Administration</h1>
      </div>
      <div class="page-content">
        <form id="admin-form" onsubmit="event.preventDefault(); saveAdminConfig();">
          <label>Départements (séparés par des virgules) :</label>
          <textarea id="admin-departments" rows="2"></textarea>
          <label>Zones (séparées par des virgules) :</label>
          <textarea id="admin-zones" rows="2"></textarea>
          <label>Priorités (séparées par des virgules) :</label>
          <textarea id="admin-priorities" rows="2"></textarea>
          <label>Métiers (séparés par des virgules) :</label>
          <textarea id="admin-trades" rows="2"></textarea>
          <button class="btn full-row" type="submit">Enregistrer</button>
        </form>
        <p><small>Les modifications prennent effet immédiatement et sont stockées localement.</small></p>
      </div> <!-- .page-content -->
    </div> <!-- .page-wrapper -->
  </section>

  <!-- Modale pour saisir des commentaires (manque d'information ou rejet) -->
  <div class="modal" id="commentModal">
    <div class="modal-content">
      <h3 id="modalTitle">Commentaire</h3>
      <textarea id="modalComment" maxlength="250" style="width:100%; height:100px; margin-bottom:1em;"></textarea>
      <div style="text-align:right;">
        <button class="btn small" onclick="closeModal(false)">Annuler</button>
        <button class="btn small" onclick="closeModal(true)">Valider</button>
      </div>
    </div>
  </div>

  <script>
    /*
      Fonctions utilitaires pour la gestion des données de la GMAO.  Les demandes
      sont stockées dans localStorage sous forme de tableau d’objets.  Chaque
      objet représente une demande avec les propriétés suivantes :
        id, date, demandeur, department, zone, equipmentDesc, equipmentNumber,
        priority, specialConditions (array), interventionConditions (array),
        description, descriptionLong, images (array d’objets { name, data }),
        status (en-attente, approuvee, manque-info, en-attente-pieces, a-ceduler,
        rejete, terminee),
        comments (array d’historiques) et worklogs (array).  Les paramètres
      d’administration (listes déroulantes) sont stockés sous la clé gmaoConfig.
    */

    /** Récupère le tableau de demandes depuis localStorage. */
    function getRequests() {
      const data = localStorage.getItem('gmaoRequests');
      return data ? JSON.parse(data) : [];
    }
    /** Sauvegarde le tableau de demandes dans localStorage. */
    function saveRequests(requests) {
      localStorage.setItem('gmaoRequests', JSON.stringify(requests));
    }
    /** Récupère la configuration (listes de départements, zones, priorités). */
    function getConfig() {
      const defaultConfig = {
        departments: ['Mécanique','Électrique','Opération','Technique','Projet','Formation'],
        zones: ['Zone A','Zone B','Zone C','Zone D'],
        priorities: ['Priorité 1 (urgent)','Priorité 2 (court terme)','Priorité 3 (à planifier)','Priorité 4 (projet)'],
        specialConditions: ['Espace clos','Travail à chaud','Levage','Nacelle','Autres'],
        interventionConditions: ['En arrêt','En fonction','En shutdown','Autres'],
        trades: ['Mécanicien','Électricien','Opérateur','Technicien','Projet','Formation']
      };
      const data = localStorage.getItem('gmaoConfig');
      return data ? { ...defaultConfig, ...JSON.parse(data) } : defaultConfig;
    }
    /** Sauvegarde la configuration dans localStorage. */
    function saveAdminConfig() {
      const cfg = {
        departments: document.getElementById('admin-departments').value.split(',').map(s => s.trim()).filter(Boolean),
        zones: document.getElementById('admin-zones').value.split(',').map(s => s.trim()).filter(Boolean),
        priorities: document.getElementById('admin-priorities').value.split(',').map(s => s.trim()).filter(Boolean),
        trades: document.getElementById('admin-trades').value.split(',').map(s => s.trim()).filter(Boolean),
        specialConditions: getConfig().specialConditions,
        interventionConditions: getConfig().interventionConditions
      };
      localStorage.setItem('gmaoConfig', JSON.stringify(cfg));
      populateDropdowns();
      alert('Configuration enregistrée.');
    }
    /** Génère un identifiant unique basé sur la date et un compteur. */
    function generateUniqueId() {
      const prefix = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
      let counter = parseInt(localStorage.getItem('gmaoCounter') || '0', 10);
      counter += 1;
      localStorage.setItem('gmaoCounter', String(counter));
      return `${prefix}-${counter}`;
    }

    /** Rafraîchit les menus déroulants selon la configuration. */
    function populateDropdowns() {
      const config = getConfig();
      const depSelect = document.getElementById('req-department');
      const zoneSelect = document.getElementById('req-zone');
      const prioSelect = document.getElementById('req-priority');
      const searchDep = document.getElementById('search-department');
      const searchZone = document.getElementById('search-zone');
      const searchPri = document.getElementById('search-priority');
      const tradeSelect = document.getElementById('req-trade');
      const searchTrade = document.getElementById('search-trade');
      // Reset existing options
      [depSelect, zoneSelect, prioSelect].forEach(sel => sel.innerHTML = '');
      config.departments.forEach(dep => {
        const opt1 = document.createElement('option'); opt1.value = dep; opt1.textContent = dep;
        depSelect.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = dep; opt2.textContent = dep;
        searchDep.appendChild(opt2);
      });
      config.zones.forEach(zone => {
        const opt1 = document.createElement('option'); opt1.value = zone; opt1.textContent = zone;
        zoneSelect.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = zone; opt2.textContent = zone;
        searchZone.appendChild(opt2);
      });
      config.priorities.forEach(prio => {
        const opt1 = document.createElement('option'); opt1.value = prio; opt1.textContent = prio;
        prioSelect.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = prio; opt2.textContent = prio;
        searchPri.appendChild(opt2);
      });
      // Corps de métier (trades)
      if (tradeSelect) tradeSelect.innerHTML = '';
      if (searchTrade) searchTrade.innerHTML = '<option value="">Tous</option>';
      config.trades && config.trades.forEach(trade => {
        if (tradeSelect) {
          const opt1 = document.createElement('option'); opt1.value = trade; opt1.textContent = trade;
          tradeSelect.appendChild(opt1);
        }
        if (searchTrade) {
          const opt2 = document.createElement('option'); opt2.value = trade; opt2.textContent = trade;
          searchTrade.appendChild(opt2);
        }
      });
      // Spécial & intervention conditions
      const specialContainer = document.getElementById('special-conditions');
      specialContainer.innerHTML = '';
      config.specialConditions.forEach(cond => {
        const label = document.createElement('label');
        label.style.marginRight = '0.5em';
        const input = document.createElement('input');
        input.type = 'checkbox'; input.value = cond;
        input.id = 'spec-' + cond;
        label.appendChild(input);
        const span = document.createElement('span');
        span.textContent = ' ' + cond;
        label.appendChild(span);
        specialContainer.appendChild(label);
      });
      const intervContainer = document.getElementById('intervention-conditions');
      intervContainer.innerHTML = '';
      config.interventionConditions.forEach(cond => {
        const label = document.createElement('label');
        label.style.marginRight = '0.5em';
        const input = document.createElement('input');
        input.type = 'checkbox'; input.value = cond;
        input.id = 'interv-' + cond;
        label.appendChild(input);
        const span = document.createElement('span');
        span.textContent = ' ' + cond;
        label.appendChild(span);
        intervContainer.appendChild(label);
      });
    }

    /* -------------------------------------------------------------------- */
    /* Gestion des utilisateurs et sessions                                 */
    /* -------------------------------------------------------------------- */
    // Liste d'utilisateurs et de rôles. Dans une vraie application, ces
    // informations seraient stockées sur un serveur sécurisé. Ici, elles servent
    // uniquement à illustrer la gestion de rôles locale.
    const users = [
      { username: 'admin',  password: 'admin',  role: 'admin' },
      { username: 'planif', password: 'planif', role: 'planificateur' },
      { username: 'meca',   password: 'meca',   role: 'Mécanicien' },
      { username: 'elec',   password: 'elec',   role: 'Électricien' },
      { username: 'cadre',  password: 'cadre',  role: 'planificateur' }
    ];

    /** Tente de connecter l'utilisateur en vérifiant le mot de passe. */
    function login() {
      const username = document.getElementById('login-user').value.trim();
      const password = document.getElementById('login-pass').value.trim();
      const user = users.find(u => u.username === username && u.password === password);
      const errorEl = document.getElementById('login-error');
      if (!user) {
        errorEl.textContent = 'Identifiants invalides.';
        return;
      }
      errorEl.textContent = '';
      localStorage.setItem('gmaoUser', JSON.stringify(user));
      showTabsForRole(user.role);
      document.getElementById('login-container').style.display = 'none';
      document.querySelector('nav').style.display = 'flex';
      document.getElementById('logout-btn').style.display = 'block';
    }

    /** Déconnecte l'utilisateur courant et réaffiche la page de connexion. */
    function logout() {
      localStorage.removeItem('gmaoUser');
      // Masquer toutes les sections
      document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
      document.querySelector('nav').style.display = 'none';
      document.getElementById('login-container').style.display = 'block';
    }

    /** Affiche uniquement les onglets autorisés pour le rôle spécifié. */
    function showTabsForRole(role) {
      document.querySelectorAll('nav button[data-roles]').forEach(btn => {
        const roles = btn.getAttribute('data-roles');
        const allowed = roles === 'all' || roles.split(',').includes(role);
        btn.style.display = allowed ? '' : 'none';
      });
      // Sélectionner l'onglet accueil par défaut
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      const homeBtn = document.getElementById('tab-home');
      if (homeBtn && homeBtn.style.display !== 'none') {
        homeBtn.classList.add('active');
        showTab('home');
      }
    }

    /** Vérifie la session au chargement et ajuste l'interface. */
    function checkSession() {
      const userData = localStorage.getItem('gmaoUser');
      if (userData) {
        const user = JSON.parse(userData);
        showTabsForRole(user.role);
        document.querySelector('nav').style.display = 'flex';
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'block';
      } else {
        document.querySelector('nav').style.display = 'none';
        document.getElementById('login-container').style.display = 'block';
      }
    }

    /** Met à jour les cartes KPI sur la page d’accueil. */
    function updateKpi() {
      const requests = getRequests();
      const counts = {
        total: requests.length,
        enAttente: requests.filter(r => r.status === 'en-attente').length,
        approuvees: requests.filter(r => r.status === 'approuvee').length,
        manqueInfo: requests.filter(r => r.status === 'manque-info').length,
        attentePieces: requests.filter(r => r.status === 'en-attente-pieces').length,
        aCeduler: requests.filter(r => r.status === 'a-ceduler').length,
        rejetees: requests.filter(r => r.status === 'rejete').length,
        terminees: requests.filter(r => r.status === 'terminee').length
      };
      const kpiContainer = document.getElementById('kpiContainer');
      kpiContainer.innerHTML = '';
      const kpis = [
        { label: 'Demandes en attente',    value: counts.enAttente },
        { label: 'Demandes approuvées',    value: counts.approuvees },
        { label: 'Manque d\'information', value: counts.manqueInfo },
        { label: 'Attente de pièces',      value: counts.attentePieces },
        { label: 'À cédule',               value: counts.aCeduler },
        { label: 'Rejetées',               value: counts.rejetees },
        { label: 'Terminées',              value: counts.terminees }
      ];
      kpis.forEach(kpi => {
        const card = document.createElement('div');
        card.className = 'kpi-card';
        const h3 = document.createElement('h3'); h3.textContent = kpi.label; card.appendChild(h3);
        const p = document.createElement('p'); p.textContent = kpi.value; card.appendChild(p);
        kpiContainer.appendChild(card);
      });
    }

    /* -------------------------------------------------------------------- */
    /* Fonctions pour créer et gérer les demandes                           */
    /* -------------------------------------------------------------------- */

    /** Soumet une nouvelle demande. */
    async function submitRequest() {
      const req = {
        id: document.getElementById('req-id').value,
        date: document.getElementById('req-date').value,
        demandeur: document.getElementById('req-demandeur').value.trim(),
        department: document.getElementById('req-department').value,
        zone: document.getElementById('req-zone').value,
        equipmentDesc: document.getElementById('req-equipment-desc').value.trim(),
        equipmentNumber: document.getElementById('req-equipment-number').value.trim(),
        trade: document.getElementById('req-trade').value,
        estimatedHours: parseFloat(document.getElementById('req-hours').value) || '',
        priority: document.getElementById('req-priority').value,
        specialConditions: Array.from(document.querySelectorAll('#special-conditions input:checked')).map(i => i.value),
        interventionConditions: Array.from(document.querySelectorAll('#intervention-conditions input:checked')).map(i => i.value),
        description: document.getElementById('req-description').value.trim(),
        descriptionLong: document.getElementById('longDescToggle').checked ? document.getElementById('req-description-long').value.trim() : '',
        status: 'en-attente'
      };
      const images = await processFiles(document.getElementById('req-images'));
      req.images = images;
      const requests = getRequests();
      requests.push(req);
      saveRequests(requests);
      document.getElementById('request-form').reset();
      document.getElementById('req-id').value = generateUniqueId();
      updateKpi();
      renderApprovalTable();
      alert('Demande soumise avec succès.');
    }

    /** Transforme les fichiers images en base64. */
    function processFiles(input) {
      return new Promise(resolve => {
        const files = Array.from(input.files || []);
        if (files.length === 0) return resolve([]);
        let count = 0;
        const images = [];
        files.forEach(f => {
          const reader = new FileReader();
          reader.onload = e => {
            images.push({ name: f.name, data: e.target.result });
            count++;
            if (count === files.length) resolve(images);
          };
          reader.readAsDataURL(f);
        });
      });
    }

    /** Met à jour la table des demandes en approbation. */
    function renderApprovalTable() {
      const tbody = document.querySelector('#approvalTable tbody');
      tbody.innerHTML = '';
      getRequests().filter(r => ['en-attente','approuvee','manque-info','en-attente-pieces','a-ceduler'].includes(r.status)).forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${req.id}</td><td>${req.date}</td><td>${req.demandeur}</td><td>${req.department}</td><td>${req.zone}</td><td>${req.equipmentDesc || ''}</td><td>${req.priority}</td><td>${formatStatus(req.status)}</td>`;
        const actionsTd = document.createElement('td');
        // Boutons d'action
        const btnApprove = document.createElement('button');
        btnApprove.className = 'btn small';
        btnApprove.textContent = 'Approuver';
        btnApprove.onclick = () => updateRequestStatus(req.id, 'approuvee');
        const btnInfo = document.createElement('button');
        btnInfo.className = 'btn small';
        btnInfo.textContent = 'Manque info';
        btnInfo.onclick = () => openCommentModal(req.id, 'manque-info');
        const btnPieces = document.createElement('button');
        btnPieces.className = 'btn small';
        btnPieces.textContent = 'Attente pièces';
        btnPieces.onclick = () => updateRequestStatus(req.id, 'en-attente-pieces');
        const btnCeduler = document.createElement('button');
        btnCeduler.className = 'btn small';
        btnCeduler.textContent = 'À cédule';
        btnCeduler.onclick = () => updateRequestStatus(req.id, 'a-ceduler');
        const btnReject = document.createElement('button');
        btnReject.className = 'btn small';
        btnReject.textContent = 'Rejeter';
        btnReject.onclick = () => openCommentModal(req.id, 'rejete');
        actionsTd.appendChild(btnApprove);
        actionsTd.appendChild(btnInfo);
        actionsTd.appendChild(btnPieces);
        actionsTd.appendChild(btnCeduler);
        actionsTd.appendChild(btnReject);
        tr.appendChild(actionsTd);
        tbody.appendChild(tr);
      });
    }

    /** Met à jour le statut d'une demande et ajoute un commentaire si nécessaire. */
    function updateRequestStatus(id, status, comment) {
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      req.status = status;
      req.comments = req.comments || [];
      req.comments.push({ date: new Date().toISOString(), status, comment });
      saveRequests(requests);
      renderApprovalTable();
      updateKpi();
    }

    /** Ouvre la modale de commentaire pour manque info ou rejet. */
    function openCommentModal(id, status) {
      const modal = document.getElementById('commentModal');
      modal.dataset.requestId = id;
      modal.dataset.status = status;
      document.getElementById('modalTitle').textContent = status === 'rejete' ? 'Raison du rejet' : 'Détails manquants';
      document.getElementById('modalComment').value = '';
      modal.style.display = 'flex';
    }

    /** Ferme la modale et envoie le commentaire si validated=true. */
    function closeModal(validated) {
      const modal = document.getElementById('commentModal');
      modal.style.display = 'none';
      if (!validated) return;
      const id = modal.dataset.requestId;
      const status = modal.dataset.status;
      const comment = document.getElementById('modalComment').value.trim();
      updateRequestStatus(id, status, comment);
    }

    /** Affiche un badge coloré en fonction du statut. */
    function formatStatus(status) {
      switch (status) {
        case 'en-attente': return '<span class="status-badge status-en-attente">En attente</span>';
        case 'approuvee': return '<span class="status-badge status-approuvee">Approuvée</span>';
        case 'manque-info': return '<span class="status-badge status-manque-info">Manque info</span>';
        case 'en-attente-pieces': return '<span class="status-badge status-en-attente-pieces">Attente pièces</span>';
        case 'a-ceduler': return '<span class="status-badge status-a-ceduler">À cédule</span>';
        case 'rejete': return '<span class="status-badge status-rejete">Rejetée</span>';
        case 'terminee': return '<span class="status-badge status-terminee">Terminée</span>';
        default: return status;
      }
    }

    /** Recherche dans les backlogs selon les filtres. */
    function performSearch() {
      const id = document.getElementById('search-id').value.trim();
      const keyword = document.getElementById('search-keyword').value.trim().toLowerCase();
      const demandeur = document.getElementById('search-demandeur').value.trim().toLowerCase();
      const dateStart = document.getElementById('search-date-start').value;
      const dateEnd = document.getElementById('search-date-end').value;
      const department = document.getElementById('search-department').value;
      const zone = document.getElementById('search-zone').value;
      const trade = document.getElementById('search-trade').value;
      const priority = document.getElementById('search-priority').value;
      const status = document.getElementById('search-status').value;
      const results = getRequests().filter(r => {
        if (id && r.id !== id) return false;
        if (keyword && !(`${r.demandeur} ${r.equipmentDesc} ${r.equipmentNumber} ${r.description}`.toLowerCase().includes(keyword))) return false;
        if (demandeur && !r.demandeur.toLowerCase().includes(demandeur)) return false;
        if (dateStart && r.date < dateStart) return false;
        if (dateEnd && r.date > dateEnd) return false;
        if (department && r.department !== department) return false;
        if (zone && r.zone !== zone) return false;
        if (trade && r.trade !== trade) return false;
        if (priority && r.priority !== priority) return false;
        if (status && r.status !== status) return false;
        return true;
      });
      const tbody = document.querySelector('#databaseTable tbody');
      tbody.innerHTML = '';
      results.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td>${r.date}</td><td>${r.demandeur}</td><td>${r.department}</td><td>${r.zone}</td><td>${r.equipmentDesc || ''}</td><td>${r.trade || ''}</td><td>${r.priority}</td><td>${formatStatus(r.status)}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* -------------------------------------------------------------------- */
    /* Fonctions pour la modification de demandes                            */
    /* -------------------------------------------------------------------- */

    const editState = { currentId: null };

    /** Charge la demande à éditer selon l'ID entré. */
    function loadEditRequest() {
      const id = document.getElementById('edit-id-input').value.trim();
      if (!id) return;
      const req = getRequests().find(r => r.id === id);
      if (!req) {
        alert('Demande introuvable.');
        return;
      }
      editState.currentId = id;
      document.getElementById('editSection').style.display = 'block';
      document.getElementById('edit-id').value = req.id;
      document.getElementById('edit-date').value = req.date;
      document.getElementById('edit-demandeur').value = req.demandeur;
      document.getElementById('edit-department').value = req.department;
      document.getElementById('edit-zone').value = req.zone;
      document.getElementById('edit-trade').value = req.trade || '';
      document.getElementById('edit-hours').value = req.estimatedHours || '';
      document.getElementById('edit-equipment-desc').value = req.equipmentDesc || '';
      document.getElementById('edit-equipment-number').value = req.equipmentNumber || '';
      document.getElementById('edit-priority').value = req.priority;
      document.querySelectorAll('#edit-special-conditions input').forEach(chk => {
        chk.checked = req.specialConditions && req.specialConditions.includes(chk.value);
      });
      document.querySelectorAll('#edit-intervention-conditions input').forEach(chk => {
        chk.checked = req.interventionConditions && req.interventionConditions.includes(chk.value);
      });
      document.getElementById('edit-description').value = req.description;
      document.getElementById('edit-longDescToggle').checked = !!req.descriptionLong;
      document.getElementById('edit-description-long').value = req.descriptionLong || '';
      document.getElementById('edit-description-long').style.display = req.descriptionLong ? 'block' : 'none';
    }

    /** Enregistre les modifications apportées à la demande en cours. */
    function saveEdit() {
      const id = editState.currentId;
      if (!id) return;
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      req.date = document.getElementById('edit-date').value;
      req.demandeur = document.getElementById('edit-demandeur').value.trim();
      req.department = document.getElementById('edit-department').value;
      req.zone = document.getElementById('edit-zone').value;
      req.trade = document.getElementById('edit-trade').value;
      req.estimatedHours = parseFloat(document.getElementById('edit-hours').value) || '';
      req.equipmentDesc = document.getElementById('edit-equipment-desc').value.trim();
      req.equipmentNumber = document.getElementById('edit-equipment-number').value.trim();
      req.priority = document.getElementById('edit-priority').value;
      req.specialConditions = Array.from(document.querySelectorAll('#edit-special-conditions input:checked')).map(i => i.value);
      req.interventionConditions = Array.from(document.querySelectorAll('#edit-intervention-conditions input:checked')).map(i => i.value);
      req.description = document.getElementById('edit-description').value.trim();
      req.descriptionLong = document.getElementById('edit-longDescToggle').checked ? document.getElementById('edit-description-long').value.trim() : '';
      processFiles(document.getElementById('edit-images')).then(images => {
        if (images.length) {
          req.images = req.images || [];
          req.images = req.images.concat(images);
        }
        saveRequests(requests);
        document.getElementById('editMessage').style.color = '#27ae60';
        document.getElementById('editMessage').textContent = 'Modifications enregistrées.';
        updateKpi();
        renderApprovalTable();
        performSearch();
      });
    }

    /** Réouvre la demande fermée (met le statut à en-attente). */
    function reopenRequest() {
      const id = editState.currentId;
      if (!id) return;
      const requests = getRequests();
      const req = requests.find(r => r.id === id);
      if (!req) return;
      req.status = 'en-attente';
      req.comments = req.comments || [];
      req.comments.push({ date: new Date().toISOString(), status: 'reouvert', comment: 'Demande réouverte par modification' });
      saveRequests(requests);
      document.getElementById('editMessage').style.color = '#27ae60';
      document.getElementById('editMessage').textContent = 'Demande réouverte.';
      updateKpi();
      renderApprovalTable();
      performSearch();
    }

    /** Imprime un bon de travail en format PDF/print. */
    function printRequest() {
      const id = editState.currentId;
      if (!id) return;
      const req = getRequests().find(r => r.id === id);
      if (!req) return;
      const w = window.open('', '_blank');
      w.document.write('<html><head><title>Bon de travail ' + req.id + '</title>');
      w.document.write('<style>body{font-family:Arial,sans-serif;padding:1em;} h1{color:#0078c8;} table{width:100%;border-collapse:collapse;} td, th{border:1px solid #ccc;padding:0.4em;} .images img{max-width:100%;margin:0.5em 0;}</style>');
      w.document.write('</head><body>');
      w.document.write('<h1>Bon de travail #' + req.id + '</h1>');
      w.document.write('<table>');
      w.document.write('<tr><th>Date</th><td>' + req.date + '</td></tr>');
      w.document.write('<tr><th>Demandeur</th><td>' + req.demandeur + '</td></tr>');
      w.document.write('<tr><th>Département</th><td>' + req.department + '</td></tr>');
      w.document.write('<tr><th>Zone</th><td>' + req.zone + '</td></tr>');
      w.document.write('<tr><th>Équipement/Service</th><td>' + (req.equipmentDesc || '') + '</td></tr>');
      w.document.write('<tr><th>NO. Équipement</th><td>' + (req.equipmentNumber || '') + '</td></tr>');
      w.document.write('<tr><th>Priorité</th><td>' + req.priority + '</td></tr>');
      w.document.write('<tr><th>Conditions spéciales</th><td>' + (req.specialConditions ? req.specialConditions.join(', ') : '') + '</td></tr>');
      w.document.write('<tr><th>Conditions d\'intervention</th><td>' + (req.interventionConditions ? req.interventionConditions.join(', ') : '') + '</td></tr>');
      w.document.write('<tr><th>Description</th><td>' + req.description + '</td></tr>');
      if (req.descriptionLong) w.document.write('<tr><th>Description longue</th><td>' + req.descriptionLong + '</td></tr>');
      w.document.write('</table>');
      if (req.images && req.images.length) {
        w.document.write('<h2>Pièces jointes</h2><div class="images">');
        req.images.forEach(img => {
          w.document.write('<img src="' + img.data + '" alt="' + img.name + '" />');
        });
        w.document.write('</div>');
      }
      if (req.worklogs && req.worklogs.length) {
        w.document.write('<h2>Travaux effectués</h2>');
        w.document.write('<table><tr><th>Date</th><th>Statut</th><th>Description</th></tr>');
        req.worklogs.forEach(log => {
          w.document.write('<tr><td>' + (log.date || '') + '</td><td>' + (log.status || '') + '</td><td>' + (log.description || '') + '</td></tr>');
        });
        w.document.write('</table>');
      }
      w.document.write('<h2>Commentaires / Travailleurs supplémentaires</h2>');
      w.document.write('<p style="border:1px solid #ccc;height:80px;"></p>');
      w.document.write('<p style="border:1px solid #ccc;height:80px;"></p>');
      w.document.write('</body></html>');
      w.document.close();
      w.print();
    }

    /* -------------------------------------------------------------------- */
    /* Fonctions pour la planification hebdomadaire                       */
    /* -------------------------------------------------------------------- */

    /** Génère la table de planification dans l'onglet Planificateur. */
    function renderPlannerTable() {
      const container = document.getElementById('plannerTable');
      const requests = getRequests().filter(r => !['terminee','rejete'].includes(r.status));
      if (requests.length === 0) {
        container.innerHTML = '<p>Aucune demande à planifier.</p>';
        return;
      }
      const days = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      ['ID','Description','Département','Métier','Priorité','Heures prévues','Jour'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      const tbody = document.createElement('tbody');
      requests.forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${req.id}</td><td>${req.equipmentDesc || ''}</td><td>${req.department}</td>`;
        const tdTrade = document.createElement('td');
        tdTrade.textContent = req.trade || '';
        tr.appendChild(tdTrade);
        const tdPrio = document.createElement('td');
        tdPrio.textContent = req.priority;
        tr.appendChild(tdPrio);
        const tdHours = document.createElement('td');
        tdHours.textContent = req.estimatedHours || '';
        tr.appendChild(tdHours);
        const tdDay = document.createElement('td');
        const select = document.createElement('select');
        select.innerHTML = '<option value="">Non assigné</option>' + days.map(d => `<option value="${d}">${d}</option>`).join('');
        select.value = req.scheduleDay || '';
        select.onchange = () => {
          req.scheduleDay = select.value;
          saveRequests(getRequests());
        };
        tdDay.appendChild(select);
        tr.appendChild(tdDay);
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    /** Exporte la planification courante au format CSV (téléchargement). */
    function exportPlannerCSV() {
      const requests = getRequests().filter(r => r.scheduleDay);
      if (requests.length === 0) {
        alert('Aucune tâche planifiée.');
        return;
      }
      const header = ['ID','Description','Département','Métier','Priorité','Heures prévues','Jour'];
      const rows = requests.map(r => [r.id, r.equipmentDesc || '', r.department, r.trade || '', r.priority, r.estimatedHours || '', r.scheduleDay]);
      let csv = header.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(v => '"' + (v || '').replace(/"/g,'""') + '"').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'planification.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    /** Soumet un journal de travail pour une demande. */
    async function submitWorklog() {
      const id = document.getElementById('worklog-id').value.trim();
      const req = getRequests().find(r => r.id === id);
      if (!req) {
        alert('Demande introuvable');
        return;
      }
      const log = {
        date: document.getElementById('worklog-date').value,
        status: document.getElementById('worklog-status').value,
        description: document.getElementById('worklog-description').value.trim()
      };
      const images = await processFiles(document.getElementById('worklog-images'));
      log.images = images;
      req.worklogs = req.worklogs || [];
      req.worklogs.push(log);
      saveRequests(getRequests());
      document.getElementById('worklog-form').reset();
      document.getElementById('worklogSection').style.display = 'none';
      alert('Journal de travail soumis.');
    }

    /** Charge la demande pour le journal de travail. */
    function loadWorklogRequest() {
      const id = document.getElementById('worklog-id').value.trim();
      const req = getRequests().find(r => r.id === id);
      if (!req) {
        alert('Demande introuvable');
        return;
      }
      document.getElementById('worklogSection').style.display = 'block';
    }

    /** Affiche un onglet donné et masque les autres. */
    function showTab(name) {
      document.querySelectorAll('.tab-content').forEach(sec => sec.classList.remove('active'));
      const section = document.getElementById(name);
      if (section) {
        section.classList.add('active');
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`[id="tab-${name}"]`);
        if (activeBtn) activeBtn.classList.add('active');
        // Actions spécifiques aux onglets
        if (name === 'approval') renderApprovalTable();
        else if (name === 'backlogs') performSearch();
        else if (name === 'planner') renderPlannerTable();
      }
    }

    /** Initialisation de la page au chargement. */
    window.addEventListener('DOMContentLoaded', () => {
      checkSession();
      populateDropdowns();
      updateKpi();
      const cfg = getConfig();
      document.getElementById('admin-departments').value = cfg.departments.join(', ');
      document.getElementById('admin-zones').value = cfg.zones.join(', ');
      document.getElementById('admin-priorities').value = cfg.priorities.join(', ');
      document.getElementById('admin-trades').value = cfg.trades.join(', ');
      const reqDate = document.getElementById('req-date');
      if (reqDate) {
        reqDate.addEventListener('focus', () => {
          document.getElementById('req-id').value = generateUniqueId();
        }, { once: true });
      }
      const editLongToggle = document.getElementById('edit-longDescToggle');
      if (editLongToggle) {
        editLongToggle.addEventListener('change', (e) => {
          const longField = document.getElementById('edit-description-long');
          longField.style.display = e.target.checked ? 'block' : 'none';
        });
      }
    });
  </script>
</body>
</html>
